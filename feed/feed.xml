<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="pretty-atom-feed.xsl" type="text/xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
  <title>Darius Foo</title>
  <subtitle>PhD student, programming languages and formal verification</subtitle>
  <link href="https://dariusf.github.io/feed/feed.xml" rel="self" />
  <link href="https://dariusf.github.io/" />
  <updated>2025-03-07T00:00:00Z</updated>
  <id>https://dariusf.github.io/</id>
  <author>
    <name>Darius Foo</name>
  </author>
  <entry>
    <title>ER Diagrams and Alloy</title>
    <link href="https://dariusf.github.io/blog/erd-alloy/" />
    <updated>2025-03-07T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/erd-alloy/</id>
    <content type="html">&lt;p&gt;I&#39;ve been curious for a while about how Alloy and ER diagrams are related.
Both are technically logics for describing relational models.
It makes sense that we should be able to encode ER diagrams in Alloy and get access to the latter&#39;s model-finding capabilities.&lt;/p&gt;
&lt;p&gt;Here&#39;s a straightforward, by-example mapping between both formalisms, paying special attention to the differences.&lt;/p&gt;
&lt;h2 id=&quot;entity-sets-relationship-sets-and-cardinality&quot;&gt;Entity sets, relationship sets, and cardinality&lt;/h2&gt;
&lt;p&gt;A direct way to represent an entity set is as an Alloy &lt;a href=&quot;https://alloy.readthedocs.io/en/latest/language/signatures.html&quot;&gt;signature&lt;/a&gt;.
Relationship sets map to &lt;a href=&quot;https://alloy.readthedocs.io/en/latest/language/signatures.html#relations&quot;&gt;relations&lt;/a&gt; (or fields) of the signature.&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;sig e1 {
  r1: one e2
}
sig e2 {}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The default &lt;a href=&quot;https://alloy.readthedocs.io/en/latest/language/signatures.html#signature-multiplicity&quot;&gt;multiplicity&lt;/a&gt; of a relation is &lt;code&gt;one&lt;/code&gt;, declared explicitly here.
This means that &lt;code&gt;r1&lt;/code&gt; is &lt;em&gt;one-to-many&lt;/em&gt;: every &lt;code&gt;e1&lt;/code&gt; is related to exactly one &lt;code&gt;e2&lt;/code&gt;, but there may be &lt;code&gt;e2&lt;/code&gt;s not related to any &lt;code&gt;e1&lt;/code&gt;s.&lt;/p&gt;
&lt;p&gt;Here is an equivalent ER diagram&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/erd-alloy/#fn1&quot; id=&quot;fnref1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div style=&quot;text-align: center&quot; class=&quot;theme-affected scroll-when-overflowing&quot;&gt;

&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
 &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Generated by graphviz version 2.43.0 (0)
 --&gt;
&lt;!-- Title: G Pages: 1 --&gt;
&lt;svg width=&quot;323pt&quot; height=&quot;44pt&quot; viewBox=&quot;0.00 0.00 322.83 44.00&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
&lt;g id=&quot;0&quot; class=&quot;graph&quot; transform=&quot;scale(1 1) rotate(0) translate(4 40)&quot;&gt;
&lt;title&gt;G&lt;/title&gt;
&lt;polygon fill=&quot;white&quot; stroke=&quot;transparent&quot; points=&quot;-4,4 -4,-40 318.83,-40 318.83,4 -4,4&quot;&gt;&lt;/polygon&gt;
&lt;!-- e1 --&gt;
&lt;g id=&quot;0_node1&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;54,-36 0,-36 0,0 54,0 54,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;27&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1 --&gt;
&lt;g id=&quot;0_node3&quot; class=&quot;node&quot;&gt;
&lt;title&gt;r1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;157.41,-36 128.09,-18 157.41,0 186.74,-18 157.41,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;157.41&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;r1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e1&amp;#45;&amp;gt;r1 --&gt;
&lt;g id=&quot;0_edge1&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;e1&amp;#45;&amp;gt;r1&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M54.3,-18C75.72,-18 105.92,-18 127.92,-18&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;91&quot; y=&quot;-21.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(1, 1)&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e2 --&gt;
&lt;g id=&quot;0_node2&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e2&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;314.83,-36 260.83,-36 260.83,0 314.83,0 314.83,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;287.83&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e2&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1&amp;#45;&amp;gt;e2 --&gt;
&lt;g id=&quot;0_edge2&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;r1&amp;#45;&amp;gt;e2&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M186.91,-18C208.93,-18 239.17,-18 260.59,-18&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;223.83&quot; y=&quot;-21.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(0, n)&lt;/text&gt;
&lt;/g&gt;
&lt;/g&gt;
&lt;/svg&gt;
&lt;/div&gt;
&lt;p&gt;Relations in Alloy are directed.
To specify the converse cardinality, we can use a signature fact, using &lt;code&gt;~&lt;/code&gt; to invert the relation:&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;sig e1 {
  r1: e2
}
sig e2 {}{ one this.~r1 }&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This means that each e1 is associated with exactly one e2 &lt;em&gt;and vice versa&lt;/em&gt;.&lt;/p&gt;
&lt;div style=&quot;text-align: center&quot; class=&quot;theme-affected scroll-when-overflowing&quot;&gt;

&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
 &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Generated by graphviz version 2.43.0 (0)
 --&gt;
&lt;!-- Title: G Pages: 1 --&gt;
&lt;svg width=&quot;323pt&quot; height=&quot;44pt&quot; viewBox=&quot;0.00 0.00 322.83 44.00&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
&lt;g id=&quot;1&quot; class=&quot;graph&quot; transform=&quot;scale(1 1) rotate(0) translate(4 40)&quot;&gt;
&lt;title&gt;G&lt;/title&gt;
&lt;polygon fill=&quot;white&quot; stroke=&quot;transparent&quot; points=&quot;-4,4 -4,-40 318.83,-40 318.83,4 -4,4&quot;&gt;&lt;/polygon&gt;
&lt;!-- e1 --&gt;
&lt;g id=&quot;1_node1&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;54,-36 0,-36 0,0 54,0 54,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;27&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1 --&gt;
&lt;g id=&quot;1_node3&quot; class=&quot;node&quot;&gt;
&lt;title&gt;r1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;157.41,-36 128.09,-18 157.41,0 186.74,-18 157.41,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;157.41&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;r1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e1&amp;#45;&amp;gt;r1 --&gt;
&lt;g id=&quot;1_edge1&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;e1&amp;#45;&amp;gt;r1&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M54.3,-18C75.72,-18 105.92,-18 127.92,-18&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;91&quot; y=&quot;-21.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(1, 1)&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e2 --&gt;
&lt;g id=&quot;1_node2&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e2&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;314.83,-36 260.83,-36 260.83,0 314.83,0 314.83,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;287.83&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e2&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1&amp;#45;&amp;gt;e2 --&gt;
&lt;g id=&quot;1_edge2&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;r1&amp;#45;&amp;gt;e2&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M186.91,-18C208.93,-18 239.17,-18 260.59,-18&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;223.83&quot; y=&quot;-21.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(1, 1)&lt;/text&gt;
&lt;/g&gt;
&lt;/g&gt;
&lt;/svg&gt;
&lt;/div&gt;
&lt;p&gt;Other cardinality constraints use different keywords:&lt;/p&gt;
&lt;div style=&quot;display: flex; justify-content: center; text-align: center&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Cardinality constraint&lt;/th&gt;
&lt;th&gt;Alloy multiplicity&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;(0, 0)&lt;/td&gt;
&lt;td&gt;none&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(0, 1)&lt;/td&gt;
&lt;td&gt;lone&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(1, 1)&lt;/td&gt;
&lt;td&gt;one&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(1, n)&lt;/td&gt;
&lt;td&gt;some&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(0, n)&lt;/td&gt;
&lt;td&gt;set&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;More on encodings &lt;a href=&quot;https://dariusf.github.io/blog/erd-alloy/#attributes-and-aggregation&quot;&gt;later&lt;/a&gt;. Let&#39;s look at some applications first.&lt;/p&gt;
&lt;h2 id=&quot;checking-properties&quot;&gt;Checking properties&lt;/h2&gt;
&lt;p&gt;With this encoding, we can already reason mechanically about ER diagrams.
For example, we can verify simple properties, such as: that the cardinality constraints we state do what we intend them to.&lt;/p&gt;
&lt;p&gt;Cardinality constraints essentially rule out some models. For example, in the following scenario, the constraint [object Promise] means...&lt;/p&gt;
&lt;div style=&quot;text-align: center&quot; class=&quot;theme-affected scroll-when-overflowing&quot;&gt;

&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
 &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Generated by graphviz version 2.43.0 (0)
 --&gt;
&lt;!-- Title: G Pages: 1 --&gt;
&lt;svg width=&quot;256pt&quot; height=&quot;44pt&quot; viewBox=&quot;0.00 0.00 255.83 44.00&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
&lt;g id=&quot;2&quot; class=&quot;graph&quot; transform=&quot;scale(1 1) rotate(0) translate(4 40)&quot;&gt;
&lt;title&gt;G&lt;/title&gt;
&lt;polygon fill=&quot;white&quot; stroke=&quot;transparent&quot; points=&quot;-4,4 -4,-40 251.83,-40 251.83,4 -4,4&quot;&gt;&lt;/polygon&gt;
&lt;!-- e1 --&gt;
&lt;g id=&quot;2_node1&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;54,-36 0,-36 0,0 54,0 54,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;27&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1 --&gt;
&lt;g id=&quot;2_node3&quot; class=&quot;node&quot;&gt;
&lt;title&gt;r1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;127.41,-36 98.09,-18 127.41,0 156.74,-18 127.41,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;127.41&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;r1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e1&amp;#45;&amp;gt;r1 --&gt;
&lt;g id=&quot;2_edge1&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;e1&amp;#45;&amp;gt;r1&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M54.11,-18C67.55,-18 83.96,-18 97.75,-18&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;76&quot; y=&quot;-21.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;c&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e2 --&gt;
&lt;g id=&quot;2_node2&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e2&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;247.83,-36 193.83,-36 193.83,0 247.83,0 247.83,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;220.83&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e2&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1&amp;#45;&amp;gt;e2 --&gt;
&lt;g id=&quot;2_edge2&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;r1&amp;#45;&amp;gt;e2&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M156.84,-18C168.58,-18 182.1,-18 193.6,-18&quot;&gt;&lt;/path&gt;
&lt;/g&gt;
&lt;/g&gt;
&lt;/svg&gt;
&lt;/div&gt;
&lt;div style=&quot;display: flex; justify-content: center; text-align: left&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Constraint [object Promise]&lt;/th&gt;
&lt;th&gt;Meaning&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;(0, 0)&lt;/td&gt;
&lt;td&gt;prevents e1 from being related to e2 at all&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(0, 1)&lt;/td&gt;
&lt;td&gt;prevents e1 from being related to e2 more than once&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(1, 1)&lt;/td&gt;
&lt;td&gt;prevents e1 from being related to e2 more or less than one&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(1, n)&lt;/td&gt;
&lt;td&gt;prevents e1 from being related to e2 less than once&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;(0, n)&lt;/td&gt;
&lt;td&gt;prevents nothing&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;Given [object Promise] is (1, 1), all the models of a particular ER diagram should satisfy properties like:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;All &lt;code&gt;e1&lt;/code&gt;s are related by &lt;code&gt;r1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;No &lt;code&gt;e1&lt;/code&gt;s are related by &lt;code&gt;r1&lt;/code&gt; multiple times&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This can all be expressed in Alloy as follows.
The &lt;code&gt;check&lt;/code&gt; command is used to verify a property, producing a counterexample if it exists within the given finite
&lt;a href=&quot;https://alloy.readthedocs.io/en/latest/language/commands.html#scopes&quot;&gt;scope&lt;/a&gt;.&lt;/p&gt;
&lt;!-- &lt;abbr title=&quot;the number of signatures in the model&quot;&gt;scope&lt;/abbr&gt;. --&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;sig e1 {
  r1: e2
}
sig e2 {}

assert no_unrelated_e1 {
  all e: e1 | some e.r1
}

assert no_multiply_related_e1 {
  no e: e1 | #e.r1 &gt; 1
}

check no_unrelated_e1 for 2
check no_multiply_related_e1 for 2&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;2 commands were executed. The results are:
   #1: No counterexample found. no_unrelated_e1 may be valid.
   #2: No counterexample found. no_multiply_related_e1 may be valid.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;whereas the same properties will not hold of &lt;code&gt;e2&lt;/code&gt;, which makes sense because we left it unconstrained.&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;assert no_unrelated_e2 {
  all e: e2 | some e.~r1
}

check no_unrelated_e2 for 2&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Executing &quot;Check no_unrelated_e2 for 2&quot;
   Actual scopes: 2 e1, 2 e2
   Solver=sat4j Bitwidth=4 MaxSeq=2 SkolemDepth=1 Symmetry=20 Mode=batch
   84 vars. 10 primary vars. 116 clauses. 5ms.
   Counterexample found. Assertion is invalid. 5ms.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The counterexample produced demonstrates rather obviously that it is possible to have an &lt;code&gt;e2&lt;/code&gt; not related to an &lt;code&gt;e1&lt;/code&gt;.&lt;/p&gt;
&lt;div style=&quot;text-align: center&quot; class=&quot;theme-affected scroll-when-overflowing&quot;&gt;

&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
 &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Generated by graphviz version 2.43.0 (0)
 --&gt;
&lt;!-- Title: G Pages: 1 --&gt;
&lt;svg width=&quot;190pt&quot; height=&quot;98pt&quot; viewBox=&quot;0.00 0.00 189.99 98.00&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
&lt;g id=&quot;3&quot; class=&quot;graph&quot; transform=&quot;scale(1 1) rotate(0) translate(4 94)&quot;&gt;
&lt;title&gt;G&lt;/title&gt;
&lt;polygon fill=&quot;white&quot; stroke=&quot;transparent&quot; points=&quot;-4,4 -4,-94 185.99,-94 185.99,4 -4,4&quot;&gt;&lt;/polygon&gt;
&lt;!-- e1_0 --&gt;
&lt;g id=&quot;3_node1&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e1_0&lt;/title&gt;
&lt;ellipse fill=&quot;none&quot; stroke=&quot;black&quot; cx=&quot;32.5&quot; cy=&quot;-18&quot; rx=&quot;32.49&quot; ry=&quot;18&quot;&gt;&lt;/ellipse&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;32.5&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e1_0&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e2_0 --&gt;
&lt;g id=&quot;3_node2&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e2_0&lt;/title&gt;
&lt;ellipse fill=&quot;none&quot; stroke=&quot;black&quot; cx=&quot;149.49&quot; cy=&quot;-18&quot; rx=&quot;32.49&quot; ry=&quot;18&quot;&gt;&lt;/ellipse&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;149.49&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e2_0&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e1_0&amp;#45;&amp;gt;e2_0 --&gt;
&lt;g id=&quot;3_edge1&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;e1_0&amp;#45;&amp;gt;e2_0&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M65.22,-18C78.04,-18 93.02,-18 106.71,-18&quot;&gt;&lt;/path&gt;
&lt;polygon fill=&quot;black&quot; stroke=&quot;black&quot; points=&quot;106.87,-21.5 116.87,-18 106.87,-14.5 106.87,-21.5&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;90.99&quot; y=&quot;-21.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;r1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e2_1 --&gt;
&lt;g id=&quot;3_node3&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e2_1&lt;/title&gt;
&lt;ellipse fill=&quot;none&quot; stroke=&quot;black&quot; cx=&quot;32.5&quot; cy=&quot;-72&quot; rx=&quot;32.49&quot; ry=&quot;18&quot;&gt;&lt;/ellipse&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;32.5&quot; y=&quot;-68.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e2_1&lt;/text&gt;
&lt;/g&gt;
&lt;/g&gt;
&lt;/svg&gt;
&lt;/div&gt;
&lt;h2 id=&quot;generating-example-models&quot;&gt;Generating example models&lt;/h2&gt;
&lt;p&gt;Alloy is also able to check if a set of constraints is satisfiable, producing a witness.
An immediate use of this is to look at examples of models, to get a feel for what an ER diagram means.&lt;/p&gt;
&lt;p&gt;The simplest way to do this is to write a command specifying only the scope&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;run {} for 2&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and select &amp;quot;Show New Solution&amp;quot; repeatedly.&lt;/p&gt;
&lt;p&gt;We can also write constraints to select models, to confirm their presence.
Say we want a model where &lt;code&gt;e1&lt;/code&gt; and &lt;code&gt;e2&lt;/code&gt; are related:&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;run { some e: e1 | some e.r1 } for 2&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;minimum-and-maximum-cardinality&quot;&gt;Minimum and maximum cardinality&lt;/h2&gt;
&lt;p&gt;Finding models can help us answer other kinds of questions, like:&lt;/p&gt;
&lt;div style=&quot;text-align: center&quot; class=&quot;theme-affected scroll-when-overflowing&quot;&gt;

&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
 &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Generated by graphviz version 2.43.0 (0)
 --&gt;
&lt;!-- Title: G Pages: 1 --&gt;
&lt;svg width=&quot;323pt&quot; height=&quot;98pt&quot; viewBox=&quot;0.00 0.00 322.83 98.00&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
&lt;g id=&quot;4&quot; class=&quot;graph&quot; transform=&quot;scale(1 1) rotate(0) translate(4 94)&quot;&gt;
&lt;title&gt;G&lt;/title&gt;
&lt;polygon fill=&quot;white&quot; stroke=&quot;transparent&quot; points=&quot;-4,4 -4,-94 318.83,-94 318.83,4 -4,4&quot;&gt;&lt;/polygon&gt;
&lt;!-- e1 --&gt;
&lt;g id=&quot;4_node1&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;54,-63 0,-63 0,-27 54,-27 54,-63&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;27&quot; y=&quot;-41.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1 --&gt;
&lt;g id=&quot;4_node3&quot; class=&quot;node&quot;&gt;
&lt;title&gt;r1&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;157.41,-90 128.09,-72 157.41,-54 186.74,-72 157.41,-90&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;157.41&quot; y=&quot;-68.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;r1&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e1&amp;#45;&amp;gt;r1 --&gt;
&lt;g id=&quot;4_edge1&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;e1&amp;#45;&amp;gt;r1:w&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M54.22,-56.14C74.1,-63.58 102.28,-72 128,-72&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;91&quot; y=&quot;-73.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(1, 1)&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e2 --&gt;
&lt;g id=&quot;4_node2&quot; class=&quot;node&quot;&gt;
&lt;title&gt;e2&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;314.83,-63 260.83,-63 260.83,-27 314.83,-27 314.83,-63&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;287.83&quot; y=&quot;-41.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;e2&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r2 --&gt;
&lt;g id=&quot;4_node4&quot; class=&quot;node&quot;&gt;
&lt;title&gt;r2&lt;/title&gt;
&lt;polygon fill=&quot;none&quot; stroke=&quot;black&quot; points=&quot;157.41,-36 128.09,-18 157.41,0 186.74,-18 157.41,-36&quot;&gt;&lt;/polygon&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;157.41&quot; y=&quot;-14.3&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;r2&lt;/text&gt;
&lt;/g&gt;
&lt;!-- e2&amp;#45;&amp;gt;r2 --&gt;
&lt;g id=&quot;4_edge3&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;e2&amp;#45;&amp;gt;r2:e&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M260.61,-33.86C240.73,-26.42 212.54,-18 186.83,-18&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;223.83&quot; y=&quot;-30.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(1, 1)&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r1&amp;#45;&amp;gt;e2 --&gt;
&lt;g id=&quot;4_edge2&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;r1:e&amp;#45;&amp;gt;e2&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M186.83,-72C212.54,-72 240.73,-63.58 260.61,-56.14&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;223.83&quot; y=&quot;-73.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(0, n)&lt;/text&gt;
&lt;/g&gt;
&lt;!-- r2&amp;#45;&amp;gt;e1 --&gt;
&lt;g id=&quot;4_edge4&quot; class=&quot;edge&quot;&gt;
&lt;title&gt;r2:w&amp;#45;&amp;gt;e1&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M128,-18C102.28,-18 74.1,-26.42 54.22,-33.86&quot;&gt;&lt;/path&gt;
&lt;text text-anchor=&quot;middle&quot; x=&quot;91&quot; y=&quot;-30.8&quot; font-family=&quot;Times,serif&quot; font-size=&quot;14.00&quot;&gt;(0, 1)&lt;/text&gt;
&lt;/g&gt;
&lt;/g&gt;
&lt;/svg&gt;
&lt;/div&gt;
&lt;p&gt;Given this ER diagram, and assuming we have 2 &lt;code&gt;e1&lt;/code&gt;s, how many &lt;code&gt;e2&lt;/code&gt;s can we have at minimum/maximum?&lt;/p&gt;
&lt;p&gt;We encode the ER diagram, then use &lt;code&gt;run&lt;/code&gt; to see if we can find a model containing 2 &lt;code&gt;e1&lt;/code&gt;s and 2 &lt;code&gt;e2&lt;/code&gt;s.
This is possible.
However, there are no satisfying models with more than 2 &lt;code&gt;e2&lt;/code&gt;s.
Why? They would violate the &lt;code&gt;lone&lt;/code&gt; constraint, as there would then be two &lt;code&gt;e2&lt;/code&gt;s related to the same &lt;code&gt;e1&lt;/code&gt; via &lt;code&gt;r2&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;sig e1 {
  r1: one e2
}{ lone this.~r2 }

sig e2 {
  r2: one e1
}

run {} for exactly 2 e1, exactly 2 e2
run {} for exactly 2 e1, exactly 3 e2&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;2 commands were executed. The results are:
   #1: Instance found. run$1 is consistent.
   #2: No instance found. run$2 may be inconsistent.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Similarly, we see that the minimum number of &lt;code&gt;e2&lt;/code&gt;s is 1.
This is because of the &lt;code&gt;one&lt;/code&gt; constraint on &lt;code&gt;r1&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;run {} for exactly 2 e1, exactly 1 e2
run {} for exactly 2 e1, exactly 0 e2&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-text&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;2 commands were executed. The results are:
   #1: Instance found. run$1 is consistent.
   #2: No instance found. run$2 may be inconsistent.&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;programmatic-use-of-alloy&quot;&gt;Programmatic use of Alloy&lt;/h2&gt;
&lt;p&gt;To build tools on top of this encoding, a way to invoke Alloy programmatically is required.&lt;/p&gt;
&lt;p&gt;Alloy &lt;a href=&quot;https://alloytools.discourse.group/t/commandline-options-clash/214&quot;&gt;does&lt;/a&gt; &lt;a href=&quot;https://alloytools.discourse.group/t/how-can-i-run-alloy-in-command-line/275&quot;&gt;not&lt;/a&gt; have a CLI.
However, it has a &lt;a href=&quot;https://alloytools.org/documentation/alloy-api/index.html&quot;&gt;well-documented Java API&lt;/a&gt; and &lt;a href=&quot;https://github.com/AlloyTools/org.alloytools.alloy/tree/master/org.alloytools.alloy.application/src/test/java/edu/mit/csail/sdg/alloy4whole&quot;&gt;examples of use&lt;/a&gt;.
Here&#39;s a minimal example of how it might be used to process an Alloy source file and export the resulting model to, e.g., GraphViz or JSON, to interoperate with other tools.
The default XML exporter does not seem to work, crashing when I tried it.&lt;/p&gt;
&lt;details&gt;
&lt;summary&gt;Minimal.java&lt;/summary&gt;
&lt;pre class=&quot;language-java&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token import&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;edu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mit&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;csail&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sdg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;alloy4&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token import&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;edu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mit&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;csail&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sdg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token import&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;edu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mit&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;csail&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sdg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Module&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token import&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;edu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mit&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;csail&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sdg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token import&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;edu&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mit&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;csail&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sdg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;translator&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Minimal&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Err&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;A4Reporter&lt;/span&gt; rep &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;A4Reporter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NOP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; filename &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token class-name&quot;&gt;Module&lt;/span&gt; world &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CompUtil&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parseEverything_fromFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rep&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; filename&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Command&lt;/span&gt; command &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; world&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAllCommands&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;A4Solution&lt;/span&gt; ans &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TranslateAlloyToKodkod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;execute_command&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rep&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; world&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAllReachableSigs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; command&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;A4Options&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ans&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;satisfiable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;// crashes&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;// ans.writeXML(&quot;output.xml&quot;);&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Sig&lt;/span&gt; s &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ans&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getAllReachableSigs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;label&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;contains&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;this&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;label &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;:&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ans&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;eval&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Sig&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Field&lt;/span&gt; f &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getFields&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;  &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;label &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;: &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; ans&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;eval&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;f&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/details&gt;
&lt;details&gt;
&lt;summary&gt;run.sh&lt;/summary&gt;
&lt;pre class=&quot;language-sh&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;token assign-left variable&quot;&gt;jar&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/Applications/Alloy.app/Contents/Resources/org.alloytools.alloy.dist.jar
&lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-ex&lt;/span&gt;
javac &lt;span class=&quot;token parameter variable&quot;&gt;-cp&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$jar&lt;/span&gt; Minimal.java
&lt;span class=&quot;token function&quot;&gt;java&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-cp&lt;/span&gt; .:&lt;span class=&quot;token variable&quot;&gt;$jar&lt;/span&gt; Minimal erd.als &lt;span class=&quot;token operator&quot;&gt;&lt;span class=&quot;token file-descriptor important&quot;&gt;2&lt;/span&gt;&gt;&lt;/span&gt; /dev/null&lt;/code&gt;&lt;/pre&gt;
&lt;/details&gt;
&lt;!-- &lt;details&gt; --&gt;
&lt;!-- &lt;summary&gt;Attributes and aggregation&lt;/summary&gt; --&gt;
&lt;h2 id=&quot;attributes-and-aggregation&quot;&gt;Attributes and aggregation&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.scielo.org.mx/scielo.php?script=sci_arttext&amp;amp;pid=S1405-55462020000100075&quot;&gt;A Method for Expressing Integrity Constraints in Database Conceptual Modeling&lt;/a&gt; (2020) is the only other article I found which also discusses encodings.
In Section 4.3.2, they give a translation scheme very briefly.&lt;/p&gt;
&lt;p&gt;I agree with their choices for attributes and values and have paraphrased them in the table below.&lt;/p&gt;
&lt;div style=&quot;display: flex; justify-content: center; text-align: left&quot; class=&quot;table-lines&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ERD&lt;/th&gt;
&lt;th&gt;Alloy&lt;/th&gt;
&lt;th&gt;Example&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Domain&lt;/td&gt;
&lt;td&gt;Signature&lt;/td&gt;
&lt;td&gt;&lt;code&gt;sig EmpId {}&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Value&lt;/td&gt;
&lt;td&gt;Singleton sub-signature&lt;/td&gt;
&lt;td&gt;&lt;code&gt;one sig John extends EmpId {}&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Attribute&lt;/td&gt;
&lt;td&gt;Field&lt;/td&gt;
&lt;td&gt;&lt;code&gt;sig Employee {id: EmpId}&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Key attribute&lt;/td&gt;
&lt;td&gt;Separate uniqueness assumption&lt;/td&gt;
&lt;td&gt;&lt;code&gt;fact {#employee = #employee.id}&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;Attributes in ER diagrams are usually simple and do not have much structure, but if we really want, we can now check properties about them.&lt;/p&gt;
&lt;p&gt;The remaining choice they make is how to model relationship sets.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;However, we chose to use signatures for representing both the entity types and the relationship types. We think this captures the relationship set semantics more accurately, and provides its own structure.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This is useful for encoding &lt;abbr title=&quot;the use of a relationship set as an entity set&quot;&gt;aggregation&lt;/abbr&gt;.
Here&#39;s an example.&lt;/p&gt;
&lt;pre class=&quot;language-alloy&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-alloy&quot;&gt;sig Bottle {}
sig Session {}
one sig Opened {
  rel: Bottle -&gt; lone Session
}
sig Member {}
one sig Tasted {
  rel: Member -&gt; Opened
}

run {} for exactly 1 Session, exactly 2 Bottle, exactly 2 Member &lt;/code&gt;&lt;/pre&gt;
&lt;!-- it seems hard to render aggregation using graphviz --&gt;
&lt;p&gt;The tradeoff is that writing constraints for ternary relations and above &lt;a href=&quot;https://alloy.readthedocs.io/en/latest/language/signatures.html#multirelations&quot;&gt;gets complex&lt;/a&gt;,
and that the default visualization is less intuitive.
It seems better to use Alloy&#39;s relations if aggregation isn&#39;t required.&lt;/p&gt;
&lt;!-- &lt;/details&gt; --&gt;
&lt;!-- TODO subtyping, covering, overlap --&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;We&#39;re using &lt;a href=&quot;https://michael-fuchs-sql.netlify.app/2021/03/03/entity-relationship-diagram-erd/#min-max-notation&quot;&gt;min-max&lt;/a&gt; &lt;a href=&quot;https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model#Cardinalities&quot;&gt;notation&lt;/a&gt;. &lt;a href=&quot;https://dariusf.github.io/blog/erd-alloy/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
  </entry>
  <entry>
    <title>Verifying effectful higher-order programs with staged logic</title>
    <link href="https://dariusf.github.io/blog/staged-logic/" />
    <updated>2024-08-16T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/staged-logic/</id>
    <content type="html">&lt;!-- (23 Aug 2024) --&gt;
&lt;!-- (13 Sep 2024) --&gt;
&lt;p&gt;&lt;em&gt;Text version of a talk given at the &lt;a href=&quot;https://nus-plse.github.io/seminars.html&quot;&gt;NUS PLSE Seminar&lt;/a&gt; and &lt;a href=&quot;https://www.fm24.polimi.it/?page_id=612&quot;&gt;FM 2024&lt;/a&gt; in Milan.&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#effectful-higher-order-functions&quot;&gt;Effectful higher-order functions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#specifying-higher-order-functions-today&quot;&gt;Specifying higher-order functions today&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#example-1-mutating-the-list&quot;&gt;Example 1: mutating the list&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#example-2-stronger-precondition&quot;&gt;Example 2: stronger precondition&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#example-3-effects-outside-metalogic&quot;&gt;Example 3: effects outside metalogic&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#staged-logic&quot;&gt;Staged logic&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#effectful-placeholders&quot;&gt;Effectful placeholders&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#recursion&quot;&gt;Recursion&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#re-summarization&quot;&gt;Re-summarization&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#compaction-via-biabduction&quot;&gt;Compaction via biabduction&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#solutions-to-problematic-examples&quot;&gt;Solutions to problematic examples&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#example-1&quot;&gt;Example 1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#example-2&quot;&gt;Example 2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#example-3&quot;&gt;Example 3&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;effectful-higher-order-functions&quot;&gt;Effectful higher-order functions&lt;/h1&gt;
&lt;p&gt;Most programming languages in use today are higher-order, and allow programmers to perform &lt;em&gt;effects&lt;/em&gt; (primitive state, exceptions, or algebraic effects) in any context.&lt;/p&gt;
&lt;p&gt;This enables expressive programming patterns, e.g. using state in a closure to avoid traversing a list twice:&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;(* sum a list, and also count the number of elements *)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; count &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ref &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; c t &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; incr count&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; c&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; xs &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;or using a continuation to return multiple solutions when backtracking, and allowing the continuation to throw an exception to end the search efficiently:&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; stop &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; raise Stop
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;rec&lt;/span&gt; search xs k &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; found &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; k answer&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;(* ... keep searching *)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; Stop &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; search xs &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; answer &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; good answer &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; stop &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Using a &lt;a href=&quot;https://github.com/ocaml-multicore/picos#motivation&quot;&gt;modern I/O library&lt;/a&gt; also makes algebraic effects pervasive.&lt;/p&gt;
&lt;p&gt;Reasoning about effectful higher-order functions does not seem particularly difficult - we certainly do it informally every time we use them in programs!
However, support for such functions in automated verifiers varies greatly:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Most automated verifiers require function arguments to be pure&lt;/em&gt;. Examples include Dafny, Why3, and Cameleer. This is because they lift these functions into the underlying logic (usually the first-order logic of SMT) and are restricted by what can be expressed in it.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Other automated verifiers rely on type system guarantees&lt;/em&gt;. Examples include Prusti and Creusot, which target Rust and can exploit the fact that closures can maintain invariants over their captured state via ownership. This makes the problem simpler, with the tradeoff that this approach does not work in languages with weaker type systems.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Most verifiers which do support such functions are interactive&lt;/em&gt;. Examples include Iris, CFML, and Steel/Pulse (F*), which are built on proof assistants. In practice, this means that they support varying levels of automation, with the tradeoff being that they are more expressive.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A second issue is that even when higher-order functions are supported, they tend to be specified &lt;em&gt;imprecisely&lt;/em&gt;. We&#39;ll see an example of this shortly.&lt;/p&gt;
&lt;p&gt;The question we&#39;re concerned with in this work is: is there a &lt;em&gt;precise&lt;/em&gt; and &lt;em&gt;general&lt;/em&gt; way to support effectful higher-order functions in &lt;em&gt;automated&lt;/em&gt; program verifiers?&lt;/p&gt;
&lt;h1 id=&quot;specifying-higher-order-functions-today&quot;&gt;Specifying higher-order functions today&lt;/h1&gt;
&lt;div style=&quot;display:none&quot;&gt;
&lt;p&gt;[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;We&#39;ll use the classic [object Promise] function as a running example.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr f a l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; l &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; a
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; h &lt;span class=&quot;token punctuation&quot;&gt;::&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
    f h &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;foldr f a t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;[object Promise] is &lt;em&gt;effectful&lt;/em&gt; - it may have state, exceptions, or algebraic effects.
[object Promise] is hence an &lt;em&gt;effectful higher-order function&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;We would like to specify [object Promise] in a way that allows a wide range of clients to be verified, including the one we saw earlier, which calls [object Promise] with a closure.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; count &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ref &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; c t &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; incr count&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; xs&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here is a specification one might write today in a modern program logic&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fn1&quot; id=&quot;fnref1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
[object Promise]&lt;ol&gt;
&lt;li&gt;&lt;span class=&quot;trigger&quot; data-id=&quot;inv&quot;&gt;The most salient feature&lt;/span&gt; of this specification is that it is parameterized over an &lt;em&gt;invariant&lt;/em&gt; [object Promise], a (separation logic) &lt;em&gt;property&lt;/em&gt; whose purpose is to describe the result of [object Promise]. It does this by relating the suffix of the list traversed so far - initially empty, and finally [object Promise] - with the result of the fold.&lt;/li&gt;
&lt;li&gt;Next, we use a &lt;span class=&quot;trigger&quot; data-id=&quot;finv&quot;&gt;nested triple&lt;/span&gt; to require that [object Promise] must preserve the invariant - assuming that the invariant holds of the portion of the list that has been folded [object Promise] and the result of the recursive call [object Promise], [object Promise] must reestablish it for [object Promise] and its result [object Promise]. This is fair, as [object Promise] contains a call to [object Promise], and so we need the knowledge that [object Promise] preserves the invariant to ensure that [object Promise] does. As the invariant is a separation logic property, it may also be seen as a way to describe the effect of [object Promise].&lt;/li&gt;
&lt;li&gt;Anticipating that some clients may want to operate only on certain kinds of lists, the specification is further &lt;span class=&quot;trigger&quot; data-id=&quot;ppred&quot;&gt;parameterized&lt;/span&gt; over a unary predicate [object Promise]. A precondition [object Promise], which must be proved at each call site, allows [object Promise] to then rely on [object Promise] in its precondition.&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;trigger&quot; data-id=&quot;shape&quot;&gt;A shape predicate&lt;/span&gt; [object Promise] relating the list structure [object Promise] to its content [object Promise] appears in both pre- and postcondition. This is to say that [object Promise] should not change the list.&lt;/li&gt;
&lt;/ol&gt;
&lt;style&gt;
  .highlight {
    color: red;
  }
  .trigger {
    text-decoration: underline;
    cursor: help;
  }
&lt;/style&gt;
&lt;script&gt;
const foldrHighlightData = {
  &#39;inv&#39;: &#39;foldrinv&#39;,
  &#39;shape&#39;: &#39;shape&#39;,
  &#39;ppred&#39;: &#39;ppred&#39;,
  &#39;finv&#39;: &#39;preserve&#39;,
};
document.addEventListener(&#39;mouseover&#39;, function(event) {
  let elt=event.target.closest(&#39;.trigger&#39;);
  if (elt !== null) {
    document.querySelectorAll(&#39;.&#39; + foldrHighlightData[elt.dataset.id])
      .forEach(a =&gt; a.classList.add(&#39;highlight&#39;));
  }
});
document.addEventListener(&#39;mouseout&#39;, function(event) {
  let elt=event.target.closest(&#39;.trigger&#39;);
  if (elt !== null) {
    document.querySelectorAll(&#39;.&#39; + foldrHighlightData[elt.dataset.id])
      .forEach(a =&gt; a.classList.remove(&#39;highlight&#39;));
  }
});
&lt;/script&gt;
&lt;p&gt;This specification elegantly solves the problem for the client we presented earlier (using an invariant to relate the value of [object Promise] and [object Promise], and an identity [object Promise]).
We argue, however, that it is &lt;em&gt;imprecise&lt;/em&gt;: there are many clients that &lt;em&gt;cannot be verified&lt;/em&gt; using it &lt;em&gt;without significant changes&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;The authors of the specification say as much&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fn1&quot; id=&quot;fnref1:1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;!-- [Iris tutorial](https://iris-project.org/tutorial-pdfs/iris-lecture-notes.pdf) says as much (pg 35): --&gt;
&lt;blockquote&gt;
&lt;p&gt;Different clients may instantiate foldr with some very different functions, hence it can be hard to give a specification for f that is reasonable and general enough to support all these choices.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The problem is that due to the use of abstract properties, this specification commits somewhat prematurely to an &lt;em&gt;abstraction&lt;/em&gt; of [object Promise]&#39;s behavior, and this abstraction may not be precise enough to verify a given client.&lt;/p&gt;
&lt;p&gt;We&#39;ll look at three examples of such clients.&lt;/p&gt;
&lt;h2 id=&quot;example-1-mutating-the-list&quot;&gt;Example 1: mutating the list&lt;/h2&gt;
&lt;p&gt;Suppose we allowed [object Promise] to mutate the list.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr_ex1 l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; x r &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;x &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
                                    x &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; l &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is not technically allowed by the shape predicate in the postcondition, but suppose we changed it to [object Promise].&lt;/p&gt;
&lt;p&gt;The problem is that [object Promise] tells us nothing about [object Promise].
The use of invariants required us to &lt;em&gt;commit to a parameterization&lt;/em&gt;, and this particular one is insufficient.&lt;/p&gt;
&lt;p&gt;To fix this, we would have to add [object Promise] as a parameter to every occurrence of [object Promise].
While adding results in a more general specification, it would also be cluttered with more anticipated client use cases.&lt;/p&gt;
&lt;h2 id=&quot;example-2-stronger-precondition&quot;&gt;Example 2: stronger precondition&lt;/h2&gt;
&lt;p&gt;Suppose we would like to pass a function argument which relies on a property concerning intermediate results of the fold.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr_ex2 l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; x r &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; x&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; l &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The problem here is that we can&#39;t use [object Promise] to strengthen the precondition of [object Promise], as we need a property relating [object Promise] and [object Promise], and [object Promise] only constrains [object Promise]. [object Promise] also cannot be used, as it only tells us about [object Promise], not [object Promise].&lt;/p&gt;
&lt;p&gt;While it is possible to assume something stronger here, e.g. [object Promise], in general it would be awkward to decompose the property into two parts.&lt;/p&gt;
&lt;h2 id=&quot;example-3-effects-outside-metalogic&quot;&gt;Example 3: effects outside metalogic&lt;/h2&gt;
&lt;p&gt;This example illustrates a different problem with invariants: suppose we allowed the function to throw an exception.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr_ex3 l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; x r &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; x&lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; x&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r
                                    &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; raise Exc&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; l &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The problem is that our specification requires [object Promise] to &lt;em&gt;return&lt;/em&gt; to preserve the invariant, and does not say anything about exceptions.&lt;/p&gt;
&lt;p&gt;The more general issue is that we are trying to abstract [object Promise]&#39;s behavior into a predicate of the underlying logic, and that limits expressiveness to that of the underlying logic.&lt;/p&gt;
&lt;p&gt;This is the reason that, as mentioned earlier, many automated verifiers do not handle closures, because they lift function arguments into the pure, first-order logic of SMT, which cannot abstract over heap manipulation.
While separation logic can, it says nothing about exceptions/effects.
One would need some kind of (monadic) encoding or &lt;a href=&quot;https://devilhena-paulo.github.io/thesis/de-vilhena-thesis.pdf&quot;&gt;protocol&lt;/a&gt;, a fundamentally different specification.&lt;/p&gt;
&lt;h1 id=&quot;staged-logic&quot;&gt;Staged logic&lt;/h1&gt;
&lt;p&gt;Taking a step back, why did we have to abstract away the behavior of [object Promise] to begin with?&lt;/p&gt;
&lt;p&gt;The problem was that it was difficult to represent (1) unknown higher-order effectful calls and (2) ordering of effects precisely in pre/post specifications.
Our idea is thus to generalize Hoare triples with the ingredients required to represent them.&lt;/p&gt;
&lt;p&gt;Suppose we think of the traditional [object Promise] and [object Promise]  as propositions in some new logical language [object Promise] for describing effectful behavior.&lt;/p&gt;
[object Promise]&lt;p&gt;[object Promise] and [object Promise] are symbolic-heap separation logic formulae,&lt;/p&gt;
[object Promise]&lt;p&gt;and [object Promise] may be thought of as a separation logic &lt;em&gt;assert&lt;/em&gt; (or &lt;em&gt;exhale&lt;/em&gt;, in Viper terms, which requires the presence of a portion of heap and consumes it), and [object Promise] as the dual notion of &lt;em&gt;assume&lt;/em&gt; (or &lt;em&gt;inhale&lt;/em&gt;, which produces a portion of heap).&lt;/p&gt;
&lt;p&gt;We then extend this language with two new constructs: sequencing and (un)interpreted relations.&lt;/p&gt;
[object Promise]&lt;!-- We call $&#92;varphi$ a *staged formula*, for reasons that will be explained shortly. --&gt;
&lt;!-- $&#92;sigma{&#92;wedge}&#92;pi$ is a symbolic-heap separation logic formula. --&gt;
&lt;p&gt;What is the semantics of such formulae? We defer a detailed answer to our paper&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fn2&quot; id=&quot;fnref2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;, but a first approximation is the following generalization, starting from the (partial correctness) semantics of Hoare triples.&lt;/p&gt;
[object Promise]&lt;p&gt;Suppose we redefined Hoare triples in terms of a new &amp;quot;bold&amp;quot; kind of triple, with the new formula type on both sides.
Intuitively, the formula on the left describes a &amp;quot;history&amp;quot;, while the formula on the right describes the behavior of [object Promise] on top of that history.&lt;/p&gt;
&lt;p&gt;This is a specific case of this new kind of triple.
The more general case could have its semantics defined as follows.&lt;/p&gt;
[object Promise]&lt;p&gt;Now we can clearly see how this new kind of triple generalizes the standard one: where we previously had a precondition [object Promise] constraining the initial state [object Promise], and a postcondition [object Promise] constraining the final state [object Promise] and result [object Promise], we now have a formula constraining the same three things, with the ability to have an arbitrary number of assertions.&lt;/p&gt;
&lt;p&gt;To give a flavour of some reasoning rules, here is the standard separation logic rule for load/deference, followed by our new one.&lt;/p&gt;
[object Promise][object Promise]&lt;!-- https://github.com/KaTeX/KaTeX/issues/471 --&gt;
&lt;p&gt;It shouldn&#39;t be too surprising, as it mostly follows the schema we just presented.&lt;/p&gt;
&lt;p&gt;The advantage of having the precondition on the right becomes clearer with the rule for function application, which is the first place where our new logic fundamentally differs.&lt;/p&gt;
[object Promise][object Promise]&lt;p&gt;First, we have the standard separation logic rule for function application. The key part is that some &lt;em&gt;knowledge&lt;/em&gt; or &lt;em&gt;specification&lt;/em&gt; of [object Promise] is required to prove that it is safe to call in a state satisfying [object Promise]. Once this is done via the entailment on the right, a postcondition [object Promise] (with appropriate substitutions) and frame [object Promise] are produced, allowing us to continue.&lt;/p&gt;
&lt;p&gt;On the other hand, the new rule requires no knowledge of the function being called, and can hence work even when [object Promise] is completely unknown, as is the case when it is a possibly effectful function parameter.
Placing the precondition on the right essentially allows us to defer checking it until a later.&lt;/p&gt;
&lt;p&gt;We call this new language of formulae &lt;em&gt;staged logic&lt;/em&gt;. It consists of the following ingredients.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Sequencing and uninterpreted relations&lt;/li&gt;
&lt;li&gt;Recursive formulae&lt;/li&gt;
&lt;li&gt;Re-summarization of recursion (lemmas)&lt;/li&gt;
&lt;li&gt;Compact sequences of pre/post stages using biabduction&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The insight is that these allow us to &lt;em&gt;defer abstraction&lt;/em&gt; until appropriate.&lt;/p&gt;
&lt;p&gt;We go over each in turn using examples, then present solutions to the clients we couldn&#39;t verify earlier before concluding.&lt;/p&gt;
&lt;h2 id=&quot;effectful-placeholders&quot;&gt;Effectful placeholders&lt;/h2&gt;
&lt;p&gt;Consider the following toy heap-manipulating program. [object Promise] is an effectful higher-order function, as it calls an unknown function [object Promise].&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; hello f x y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  x &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; f y &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; r2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; r &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  y &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; r2&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  r2&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here is a possible specification for it.&lt;/p&gt;
[object Promise]&lt;p&gt;Sequencing and uninterpreted relations together allow us to leave placeholders for unknown function parameters, to represent their effects.&lt;/p&gt;
&lt;p&gt;Stateful behavior is otherwise &lt;em&gt;compacted&lt;/em&gt; into a single [object Promise]/[object Promise] pair.&lt;/p&gt;
&lt;!-- $f$ may be seen as *stratifying* the behavior of $&#92;m{hello}$ into two *stages* under [compaction](#compaction-via-biabduction), hence the name &quot;staged formulae&quot;, in allusion to *staged programming*. --&gt;
&lt;p&gt;One might wonder why we must require the presence of [object Promise] and [object Promise] after the call to [object Promise].
For [object Promise], this is easy, as it is passed as an argument to [object Promise], and we have to require that it is not, e.g., deallocated.
Interestingly, we also cannot assume anything about [object Promise] after the call to [object Promise]. As [object Promise] is unknown and arbitrary, it is possible that it may capture [object Promise] and cause it to have a potentially different value after, [object Promise].&lt;/p&gt;
&lt;p&gt;Another detail is that this specification assumes that [object Promise] and [object Promise] are not aliased. Details on how to relax this assumption are in the paper&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fn2&quot; id=&quot;fnref2:1&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;!--

Sequencing of multiple effectful functions can be represented directly.

```ocaml
let compose f g x = f (g x)
```

$$
&#92;m{compose}(f, g, x, &#92;m{res}) = &#92;exists r.&#92; g(x, r); f(r, &#92;m{res})
$$

--&gt;
&lt;h2 id=&quot;recursion&quot;&gt;Recursion&lt;/h2&gt;
&lt;p&gt;Recursive programs are naturally represented by recursive specifications.&lt;/p&gt;
&lt;!-- under a least fixed point interpretation --&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr f a l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; l &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; a
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; h &lt;span class=&quot;token punctuation&quot;&gt;::&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
    f h &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;foldr f a t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;here is a staged logic specification for it:&lt;/p&gt;
[object Promise]&lt;p&gt;Most importantly, the call to [object Promise] can be represented directly, without abstraction.&lt;/p&gt;
&lt;p&gt;This specification looks very much like the program, because there is no state that could benefit from being expressed with separation logic.
However, it is still an abstraction of the program.&lt;/p&gt;
&lt;p&gt;Comparing this to the previous specification, this time expressed as a single [object Promise]/[object Promise] pair in staged logic,&lt;/p&gt;
[object Promise]&lt;p&gt;we see that it is longer and more complex, and contains all kinds of paramterization to make up for the inability to speak simply about ordering.
Leaving the recursion in the specification &lt;em&gt;before&lt;/em&gt; we are aware of what clients expect (and thus, what kind of abstraction is appropriate) is what allows staged specifications to be more precise.&lt;/p&gt;
&lt;!-- not precise when it comes to concurrency due to summary of stateful behavior, which may no longer be atomic --&gt;
&lt;h2 id=&quot;re-summarization&quot;&gt;Re-summarization&lt;/h2&gt;
&lt;p&gt;We previously saw function calls represented without any abstraction in specifications, which probably wouldn&#39;t work well in large programs.
We would hence like to recover abstraction at some appropriate time.
That time tends to be at calls;
given a use of [object Promise] such as the following, which passes a closure as an argument,&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr_sum_state x xs init &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; g c t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; c &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; t &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  foldr g xs init&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and a user-provided specification (below), we can verify the above program by proving the following entailment.&lt;/p&gt;
[object Promise]&lt;p&gt;This may also be seen as a means of &lt;em&gt;recovering abstraction&lt;/em&gt;,
or &lt;em&gt;re-summarizing&lt;/em&gt; the relatively low-level staged specification,
to get rid of recursion and explicit occurrences of unknown functions
and produce a simpler, non-recursive summary of its behavior.&lt;/p&gt;
&lt;p&gt;This example also demonstrates the utility of staged logic,
which allows us to very plainly state the effectful behavior of the program,
and also &lt;em&gt;prove the entailment automatically&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;In the paper&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fn2&quot; id=&quot;fnref2:2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;, we define a set of syntactic proof rules for reducing [object Promise]-entailments (modulo &lt;em&gt;compaction&lt;/em&gt;) into separation logic proof obligations,
which can be discharged using an off-the-shelf SL prover and SMT.
This particular proof uses an inferred (or provided, in general) induction hypothesis.&lt;/p&gt;
&lt;h2 id=&quot;compaction-via-biabduction&quot;&gt;Compaction via biabduction&lt;/h2&gt;
&lt;p&gt;The final piece is &lt;em&gt;compaction&lt;/em&gt;, which allows us to have the expressiveness of stages, but also the &lt;em&gt;succinctness&lt;/em&gt; of triples when the extra expressiveness is not needed.
In short, it allows any staged formula to always be transformed into the following normal form.&lt;/p&gt;
[object Promise]&lt;p&gt;Compaction can be seen as a normalization procedure for (programs represented as) staged formulae.
This is key not only for entailment proofs, but for automation:
in our prototype, users only need to provide essential lemmas, and all other intermediate specifications are derived mechanically.
In this way, compaction functions as a means of specification inference in a verification setting.&lt;/p&gt;
&lt;p&gt;We&#39;ll illustrate it by example on the heap-manipulating [object Promise] program we saw earlier.&lt;/p&gt;
[object Promise]&lt;p&gt;This specification is already in normal form, but suppose we find out an interpretation for [object Promise], for example, from the following client.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; z &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ref &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ref &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
hello &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; incr z&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; z y&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we have the following interpretation for [object Promise].&lt;/p&gt;
[object Promise]&lt;p&gt;Unfolding [object Promise] in [object Promise] (and doing some renaming),&lt;/p&gt;
[object Promise]&lt;p&gt;This specification is not in normal form.
Focusing on the boxed portions, we see an [object Promise] followed by a [object Promise].
We can apply the following normalization rule.&lt;/p&gt;
[object Promise]&lt;p&gt;In other words, it suffices to solve a &lt;a href=&quot;https://fbinfer.com/docs/separation-logic-and-bi-abduction/&quot;&gt;biabductive entailment&lt;/a&gt; to infer a pair of &lt;em&gt;frame&lt;/em&gt; (in the separation logic sense) and &lt;em&gt;antiframe&lt;/em&gt; (an additional condition [object Promise] required for [object Promise] to entail [object Promise]).
We can then use these in place of the original conditions, &amp;quot;swapping&amp;quot; them around, or &amp;quot;pushing&amp;quot; the [object Promise] &amp;quot;through&amp;quot; the [object Promise].&lt;/p&gt;
&lt;p&gt;For this example, one solution is:&lt;/p&gt;
[object Promise]&lt;p&gt;We can thus transform [object Promise] as follow.&lt;/p&gt;
[object Promise]&lt;p&gt;Now we have two consecutive [object Promise] and [object Promise] stages.
We can normalize them using the following rules.&lt;/p&gt;
[object Promise]&lt;p&gt;Now we have this, and again we have another [object Promise]/[object Promise] pair.&lt;/p&gt;
[object Promise]&lt;p&gt;Here&#39;s the solution...&lt;/p&gt;
[object Promise]&lt;p&gt;... and final state, after one more round of simplification (not shown).&lt;/p&gt;
[object Promise]&lt;p&gt;Now the specification for this call to [object Promise] is in normal form, and we can use it for subsequent reasoning.
We see also that it precisely captures the aggregate behavior of this call, including the state changes.&lt;/p&gt;
&lt;h1 id=&quot;solutions-to-problematic-examples&quot;&gt;Solutions to problematic examples&lt;/h1&gt;
&lt;p&gt;Going back to the problematic clients we highlighted previously,
how can we tackle them using staged logic,
and how does the approach differ from the invariant-based way of writing specifications given in the introduction?&lt;/p&gt;
&lt;p&gt;All the following assume the specification for [object Promise] is as given in the previous section.
Crucially, none have to change it to solve all problems.&lt;/p&gt;
&lt;h2 id=&quot;example-1&quot;&gt;Example 1&lt;/h2&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr_ex1 l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; x r &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;x &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
                                    x &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; l &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;An invariant to tell us about the content of the list is not needed.
Instead, we describe the final content of the list in terms of the initial content using a pure function [object Promise], alongside the result.
The list is described using a shape predicate.&lt;/p&gt;
[object Promise]&lt;!--

$$
&#92;begin{array}{l}
&#92;m{mapinc}(&#92;xs, &#92;ys) = &#92;&#92;
&#92;quad &#92;phantom{&#92;vee&#92; } (&#92;xs{=}[]{&#92;wedge}&#92;ys) &#92;&#92;
&#92;quad &#92;vee&#92; (&#92;exists x, &#92;xs_1, &#92;ys.&#92; &#92;xs{=}x{::}&#92;xs_1{&#92;wedge}&#92;ys{=}(x{+}1){::}&#92;ys_1) &#92;wedge &#92;m{mapinc}(&#92;xs_1, &#92;ys_1) &#92;&#92; &#92;&#92;
&#92;list(l, &#92;m{rs}) = &#92;&#92;
&#92;quad &#92;phantom{&#92;vee&#92; } (&#92;emp{&#92;wedge}l{=}[]) &#92;&#92;
&#92;quad &#92;vee&#92; (&#92;exists x, &#92;m{rs}_1, l_1.&#92; x{&#92;mapsto}r * &#92;list(l_1,&#92;m{rs}_1){&#92;wedge}l{=}x{::}l_1 {&#92;wedge} &#92;m{rs}{=}r{::}&#92;m{rs}_1)
&#92;end{array}
$$

--&gt;
&lt;h2 id=&quot;example-2&quot;&gt;Example 2&lt;/h2&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr_ex2 l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; x r &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r&lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; x&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; l &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To enable the assertion in the function argument to be proved, we explicate the assumption that all suffix-sums of the list are positive using a pure function of [object Promise]. This can be directly given as part of the user-provided specificaton on the right.&lt;/p&gt;
[object Promise]&lt;p&gt;In this example, we are not concerned with shapes, and fittingly, shape predicates do not appear at all in the specification or lemma.&lt;/p&gt;
&lt;!--
$$
&#92;begin{array}{l}
&#92;m{allSPos}(l) = &#92;&#92;
&#92;phantom{&#92;vee&#92; } (l{=}[]) &#92;&#92;
&#92;vee&#92; (&#92;exists x, r, l_1.&#92; l=x{::}l_1 &#92;wedge &#92;m{allSPos}(l_1)&#92;wedge &#92;m{sum}(l,r) &#92;wedge r{&#92;geq}0)
&#92;end{array}
$$
--&gt;
&lt;h2 id=&quot;example-3&quot;&gt;Example 3&lt;/h2&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; foldr_ex3 l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foldr &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; x r &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; x&lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; x&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;r
                                    &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; raise Exc&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; l &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;An exception can be modelled as an &lt;em&gt;interpreted&lt;/em&gt; relation (more on the semantics of handlers in our ICFP 2024 paper&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fn3&quot; id=&quot;fnref3&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;).&lt;/p&gt;
&lt;!-- Given a pure function to describe lists containing only positive elements,

$$
&#92;begin{array}{l}
&#92;m{allPos}(l) = &#92;&#92;
&#92;phantom{&#92;vee&#92; } (l{=}[]) &#92;&#92;
&#92;vee&#92; (&#92;exists x, l_1.&#92; l=x{::}l_1 &#92;wedge &#92;m{allPos}(l_1)&#92;wedge r{&#92;geq}0)
&#92;end{array}
$$

--&gt;
&lt;p&gt;We can give a precise description of the conditions under which an exception is thrown via the following entailment.&lt;/p&gt;
[object Promise]&lt;p&gt;The underlying logic is still symbolic-heap separation logic; we do not delegate effects to it.
Staged logic may thus be seen as a behavioral layer on top of separation logic, which excels when one is describing individual program states.&lt;/p&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;We have described &lt;em&gt;staged logic&lt;/em&gt;, a generalization of Hoare triples for specifying effectful higher-order programs and verifying them in an automated setting.&lt;/p&gt;
&lt;p&gt;It fits well into the standard workflow of automated program verifiers:
given a program and a property it should satisfy,
a staged formula is derived from the program,
and the resulting entailment is automatically proved,
with lemmas and induction hypotheses provided by the user.&lt;/p&gt;
&lt;p&gt;Since staged logic generalizes Hoare logic,
one can easily &amp;quot;fall back&amp;quot; to triples in cases where the expressiveness of stages is not needed,
and employ abstraction, invariants, and all the other techniques which have been developed for program proofs.
There is no need to always specify programs as disjunctions of paths, or always capture the ordering of every function call and effect,
however the crucial thing is that &lt;em&gt;the option to do so is available&lt;/em&gt; where it makes specifications more natural.&lt;/p&gt;
&lt;p&gt;Check out our paper&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fn2&quot; id=&quot;fnref2:3&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; for the details.&lt;/p&gt;
&lt;p&gt;These ideas have been implemented in a prototype verifier called &lt;a href=&quot;https://github.com/hipsleek/heifer&quot;&gt;Heifer&lt;/a&gt;, which we hope will grow into a practical verification tool for real programs.&lt;/p&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;Taken from the &lt;a href=&quot;https://iris-project.org/tutorial-pdfs/iris-lecture-notes.pdf&quot;&gt;Iris lecture notes&lt;/a&gt;, pg 32 &lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fnref1:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;Our FM24 paper may be found &lt;a href=&quot;https://raw.githubusercontent.com/hipsleek/Heifer/StagedSL/docs/FM2024_TR.pdf&quot;&gt;here&lt;/a&gt; &lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fnref2:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fnref2:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fnref2:3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;Our ICFP24 paper may be found &lt;a href=&quot;https://www.comp.nus.edu.sg/~yahuis/ICFP24/ICFP2024.pdf&quot;&gt;here&lt;/a&gt; &lt;a href=&quot;https://dariusf.github.io/blog/staged-logic/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
  </entry>
  <entry>
    <title>Choreographic PlusCal</title>
    <link href="https://dariusf.github.io/blog/cpluscal/" />
    <updated>2023-12-31T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/cpluscal/</id>
    <content type="html">&lt;p&gt;Choreographic PlusCal is a refinement of PlusCal with features for specifying distributed protocols.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;choreography&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;C &#92;in coordinators&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;P &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &#92;in coordinators&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    task C&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;phase1&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;prepare&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        either &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;prepared&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; or &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;aborted&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          cancel &lt;span class=&quot;token string&quot;&gt;&quot;phase1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;aborted&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;abort&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;aborted&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;commit&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;committed&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;roles-and-parties&quot;&gt;Roles and parties&lt;/h2&gt;
&lt;p&gt;Protocol models in Choreographic PlusCal begin with definitions of &lt;em&gt;roles&lt;/em&gt;, &lt;em&gt;parties&lt;/em&gt;, and their local variables.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;choreography&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;F &#92;in failure_detectors&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;P &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  variables
    voted_yes &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    voted_no &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; FALSE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    outcome &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;none&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A &lt;em&gt;party&lt;/em&gt; is an identifier for a protocol participant, and is typically a model value.
Protocol participants have local state and communicate via messages.
A &lt;em&gt;role&lt;/em&gt; is a set of parties.&lt;/p&gt;
&lt;h2 id=&quot;choreography-and-transmit&quot;&gt;choreography and Transmit&lt;/h2&gt;
&lt;p&gt;A &lt;code&gt;choreography&lt;/code&gt; lives at the same level as a PlusCal &lt;code&gt;process&lt;/code&gt;, and is special in that it describes the protocol &lt;em&gt;globally&lt;/em&gt;, from the perspective of all parties simultaneously.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;choreography&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;C &#92;in coordinators&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;P &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &#92;in coordinators&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;b&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Within a &lt;code&gt;choreography&lt;/code&gt;, new global constructs can be used.
The most important is &lt;code&gt;Transmit&lt;/code&gt; for sending messages, which can be arbitrary data.
Any network semantics can be specified for it by implementing simple &lt;code&gt;Send&lt;/code&gt; and &lt;code&gt;Receive&lt;/code&gt; macros.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;macro &lt;span class=&quot;token function&quot;&gt;Send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  messages &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; messages &#92;&lt;span class=&quot;token keyword&quot;&gt;union&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;To &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; From &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Type &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

macro &lt;span class=&quot;token function&quot;&gt;Receive&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  await &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;To &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; to&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; From &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; from&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Type &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; type&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &#92;in messages&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Choreographic PlusCal works by &lt;em&gt;projecting&lt;/em&gt; choreographies into regular PlusCal processes, so it fits nicely into the PlusCal translator pipeline.&lt;/p&gt;
&lt;h2 id=&quot;all-and-par&quot;&gt;all and par&lt;/h2&gt;
&lt;p&gt;Multicasts are the workhorse of consensus and commit protocols, among other role-uniform operations.
These are expressible with &lt;code&gt;all&lt;/code&gt;, which is dual to PlusCal&#39;s &lt;a href=&quot;https://lamport.azurewebsites.net/pubs/pluscal.pdf&quot;&gt;&lt;code&gt;with&lt;/code&gt;&lt;/a&gt;: instead of executing its body for an arbitrarily chosen element of a set, its body executes for &lt;em&gt;all&lt;/em&gt; elements of the set, &lt;em&gt;concurrently&lt;/em&gt;.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;choreography&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;C &#92;in coordinators&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;P &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &#92;in coordinators&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;prepare&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;par { ... } and { ... }&lt;/code&gt;, which is dual to &lt;code&gt;either { ... } or { ... }&lt;/code&gt;, is used for parallel composition of different blocks of statements, instead of the same block many times.&lt;/p&gt;
&lt;p&gt;Unlike PlusCal process and Distributed PlusCal threads, &lt;code&gt;par&lt;/code&gt; and &lt;code&gt;all&lt;/code&gt; can be nested arbitrarily.
Both have a fork-join semantics when composed sequentially.&lt;/p&gt;
&lt;h2 id=&quot;tasks-and-cancellation&quot;&gt;Tasks and cancellation&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;task&lt;/code&gt;s delimit a block of statements which will no longer take effect following a &lt;code&gt;cancel&lt;/code&gt;lation.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  task P&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    par &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      cancel &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; and &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      x &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &#92;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; x is &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; or &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; on each participant&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In the Two-phase Commit example above, the task delimits the first phase of the protocol, which ends &lt;em&gt;as soon as&lt;/em&gt; the first &lt;code&gt;&amp;quot;aborted&amp;quot;&lt;/code&gt; message is received.
Notably, the coordinator will no longer even &lt;em&gt;receive&lt;/em&gt; messages following the cancellation, and does not have to wait for &lt;code&gt;all&lt;/code&gt; subprocesses to be &amp;quot;joined&amp;quot;.&lt;/p&gt;
&lt;p&gt;This provides a principled and easy way to implement such optimizations, which would otherwise be tricky to express.&lt;/p&gt;
&lt;p&gt;Cancellation is also an interesting control flow primitive.
For example, it can be &lt;a href=&quot;https://github.com/dariusf/tlaplus/blob/mbtc/cpcal.t/RaftLE.tla&quot;&gt;used with loops&lt;/a&gt; to express infinite repetition of a task which completes to a different extent each time.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;TRUE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  task servers&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;s&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    par &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &#92;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; A
      &#92;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; B
      &#92;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; C
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; and &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      cancel &lt;span class=&quot;token string&quot;&gt;&quot;s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &#92;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; produces the &lt;span class=&quot;token function&quot;&gt;behavior&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;C&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;dynamic-multirole-protocols-and-self-sends&quot;&gt;Dynamic multirole protocols and self-sends&lt;/h2&gt;
&lt;p&gt;Protocols such as &lt;a href=&quot;https://github.com/dariusf/tlaplus/blob/mbtc/cpcal.t/NBAC.tla&quot;&gt;Nonblocking Atomic Commit&lt;/a&gt; feature intra-role communication, or &lt;em&gt;self-sends&lt;/em&gt;. Others such as &lt;a href=&quot;https://github.com/dariusf/tlaplus/blob/mbtc/cpcal.t/RaftLE.tla&quot;&gt;Raft&lt;/a&gt; additionally have only a single static role, changing role dynamically based on node state.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s &#92;in servers&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;RequestVote&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Choreographic PlusCal handles both in a principled way with a &lt;a href=&quot;https://dariusf.github.io/selfsends&quot;&gt;projection function&lt;/a&gt; based on the theory of dynamic multirole session types.&lt;/p&gt;
&lt;h2 id=&quot;multiparty-loops&quot;&gt;Multiparty loops&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;Multiparty loops&lt;/em&gt; allow repetition across multiple roles, with a termination condition for each role to be projected with respect to.&lt;/p&gt;
&lt;pre class=&quot;language-c&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &#92;in coordinators&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &#92;in participants&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;Transmit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      y &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      x &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;prototype&quot;&gt;Prototype&lt;/h2&gt;
&lt;p&gt;This project is a research prototype and its &lt;a href=&quot;https://github.com/dariusf/tlaplus/tree/mbtc&quot;&gt;implementation&lt;/a&gt; is mostly a proof-of-concept.
However, it is built on top of the TLA+ tools, so with more work it could someday be used to specify (and verify) real protocols.
Please get in touch if you are interested!&lt;/p&gt;
&lt;h2 id=&quot;resources&quot;&gt;Resources&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/dariusf/tlaplus/tree/mbtc/cpcal.t&quot;&gt;Gallery of example programs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/selfsends&quot;&gt;How projection works&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://dariusf.github.io/cpluscal.pdf&quot;&gt;The paper&lt;/a&gt;, which contains an extensive tutorial-style introduction and lots of detail on how projection and translation to PlusCal work&lt;/li&gt;
&lt;/ul&gt;
</content>
  </entry>
  <entry>
    <title>Self-send projection</title>
    <link href="https://dariusf.github.io/blog/selfsends/" />
    <updated>2023-11-28T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/selfsends/</id>
    <content type="html">&lt;div style=&quot;display:none&quot;&gt;
&lt;p&gt;[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://wen.works/2020/12/17/an-introduction-to-session-types/&quot;&gt;Session types&lt;/a&gt; are a neat and fascinating formalism.
Intuitively, they are small languages for describing communication protocols.
Viewing these protocols as types, a type system may be used to check that a program implements a protocol correctly and has other nice properties, such as deadlock-freedom.
Unlike types which constrain data, session types are &lt;em&gt;behavioral&lt;/em&gt; specifications and constrain what &lt;em&gt;programs&lt;/em&gt; can &lt;em&gt;do&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Multiparty session types&lt;/em&gt; concern more than two communicating parties and are usually written in &lt;a href=&quot;https://en.wikipedia.org/wiki/Security_protocol_notation&quot;&gt;&amp;quot;Alice &amp;amp; Bob notation&amp;quot;&lt;/a&gt;, specifying a protocol from a so-called &lt;em&gt;global&lt;/em&gt; perspective.&lt;/p&gt;
&lt;p&gt;Here&#39;s the syntax of a tiny MPST language.&lt;/p&gt;
[object Promise]&lt;p&gt;We can write a type such as&lt;/p&gt;
[object Promise]&lt;p&gt;which specifies a protocol where party [object Promise] sends the message [object Promise] to party [object Promise], and [object Promise] &lt;em&gt;then&lt;/em&gt; replies with message [object Promise].&lt;/p&gt;
&lt;p&gt;Say we have a program that implements party [object Promise], and we want to check it against the protocol.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Receive&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;One approach is to split the global type into two &lt;em&gt;local&lt;/em&gt; halves, then check the program against the half for [object Promise].
This splitting operation is called &lt;em&gt;projection&lt;/em&gt; because we are keeping only a slice or subpart of the behavior of the overall system, or some subsequences of its execution traces, etc.&lt;/p&gt;
&lt;p&gt;Here is a tiny language of local types.&lt;/p&gt;
[object Promise]&lt;p&gt;The projections for [object Promise] and [object Promise] would be:&lt;/p&gt;
[object Promise][object Promise]&lt;p&gt;How do we compute such a projection?&lt;/p&gt;
&lt;!-- We write $G &#92;upharpoonright S$ for the projection of global type $G$ on a set of parties $S$. --&gt;
[object Promise]&lt;p&gt;The rules are very simple for this tiny language:
projection is &amp;quot;pushed through&amp;quot; sequential composition,
and if we are projecting [object Promise] with respect to a given party [object Promise] and we see [object Promise] is the sender, the result is a [object Promise], otherwise it is a [object Promise].&lt;/p&gt;
&lt;!--

Both $&#92;to$ cases assume $a&#92;neq b$.

&lt;details&gt;
    &lt;summary&gt;What if $a=b$, i.e. how should we project $a &#92;to a: m$?&lt;/summary&gt;
    It seems like the result should be $&#92;m{send}&#92; a&#92; m; &#92;m{recv}&#92; a$. We&#39;ll solve this shortly.
&lt;/details&gt;

&lt;details&gt;
    &lt;summary&gt;What if $a&#92;neq b &#92;neq m$?&lt;/summary&gt;
    The result is a no-op. We don&#39;t discuss this for brevity.
&lt;/details&gt;

--&gt;
&lt;!-- proof --&gt;
&lt;h2 id=&quot;multicasts&quot;&gt;Multicasts&lt;/h2&gt;
&lt;p&gt;It would be amazing if we could model a real-world protocol like &lt;a href=&quot;https://raft.github.io/&quot;&gt;Raft&lt;/a&gt; as a type and have the conformance of an implementation checked automatically and decideably!&lt;/p&gt;
&lt;p&gt;We are still quite a long way off.
One major missing ingredient is the ability to express a multicast, the first step in leader election.&lt;/p&gt;
&lt;p&gt;Let&#39;s extend our language of multiparty session types with a way to talk about communication that happens uniformly across a set of parties, which we&#39;ll call a &lt;em&gt;role&lt;/em&gt;. We&#39;ll use the symbol [object Promise] for it, as an analogy to universal quantification.
We&#39;ll also add parallel composition [object Promise].&lt;/p&gt;
[object Promise]&lt;p&gt;We can now write a type like&lt;/p&gt;
[object Promise]&lt;p&gt;which would suffice for the start of a &lt;a href=&quot;https://en.wikipedia.org/wiki/Two-phase_commit_protocol#Basic_algorithm&quot;&gt;commit protocol&lt;/a&gt;.
Notice that [object Promise] is just n-ary parallel composition for each party in the role.&lt;/p&gt;
&lt;p&gt;Projection should give us&lt;/p&gt;
[object Promise]&lt;p&gt;which matches our intuition neatly:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;when we project with respect to the set of coordinators, we want to get a local type which says what &lt;em&gt;one arbitrary&lt;/em&gt; coordinator does. Since this coordinator isn&#39;t in [object Promise] but interacts with every member of [object Promise], the quantifier should remain in the local type [object Promise], which correctly captures the multicast.&lt;/li&gt;
&lt;li&gt;when we project with respect to the set of participants, since our arbitrary participant is in [object Promise], it is involved in &lt;em&gt;only one&lt;/em&gt; [object Promise], so the quantifier should disappear.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here is the projection function for [object Promise], which is now defined with respect to a role [object Promise].&lt;/p&gt;
[object Promise]&lt;h2 id=&quot;self-sends&quot;&gt;Self-sends&lt;/h2&gt;
&lt;p&gt;For leader election, however, we quickly run into a problem.&lt;/p&gt;
[object Promise]&lt;p&gt;The rules from before don&#39;t help us much - do we keep the quantifier or not?
Also, it seems that a server should both [object Promise] and [object Promise], but since there is only one role to project with respect to, we can only have one of those.&lt;/p&gt;
&lt;p&gt;We call this sort of intra-role communication a &lt;em&gt;self-send&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;The paper &lt;a href=&quot;http://mrg.doc.ic.ac.uk/publications/dynamic-multirole-session-types/dynamic-multirole-session-types.pdf&quot;&gt;Dynamic Multirole Session Types (2013)&lt;/a&gt; proposes an elegant solution, based on the following observation, or lemma: given an arbitrary party [object Promise] in role [object Promise], the following types are equivalent.&lt;/p&gt;
[object Promise]&lt;p&gt;That is, a universal quantification is just the parallel composition of &amp;quot;what [object Promise] does&amp;quot; and &amp;quot;what everyone else does&amp;quot;.&lt;/p&gt;
&lt;!-- It turns out that projecting the parallel composition instead solves the problem! --&gt;
&lt;!-- If we project the parallel composition instead, maybe that would solve the problem? --&gt;
&lt;p&gt;The solution is thus to project the parallel composition instead,
with respect to &lt;em&gt;the party&lt;/em&gt; [object Promise], instead of &amp;quot;an arbitrary party of role [object Promise]&amp;quot;.
Before, these were equivalent because we didn&#39;t need to be sensitive to which party in a role we were concerned with.&lt;/p&gt;
&lt;!-- distinguish different parties of the same role. --&gt;
&lt;!-- To get a feel for it, --&gt;
&lt;!-- let&#39;s first refine our language a bit. --&gt;
&lt;p&gt;For explicitness, we&#39;ll refine [object Promise] with a set of exclusions [object Promise], which may be empty.&lt;/p&gt;
[object Promise]&lt;!-- There is a problem, however. This is certainly a valid MPST.
There may be seen as a tiny part of what does, where there is only a single set of nodes exchanging messages, assuming different roles dynamically (e.g. when a leader is elected, or on timeout).
--&gt;
&lt;p&gt;There are two cases for [object Promise].&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;If [object Promise] but [object Promise], i.e. it is possible that the quantifier involves [object Promise], we first apply the lemma above, which separates the behavior of [object Promise] from that of everyone else in [object Promise], then recursively project on both sides.&lt;/p&gt;
[object Promise]&lt;p&gt;Intuitively, the left arm is what [object Promise] does, while the right is &lt;em&gt;what other parties do to&lt;/em&gt; [object Promise].
[object Promise] is involved in both sides of the [object Promise] precisely because members of the same set being quantified over are interacting.
If we were projecting a protocol without a self-send, the right arm would be unobservable and disappear, and we would the same result as the projection function from the previous section!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Otherwise (if [object Promise] or [object Promise]), we keep the quantifier and project under it, for the same reason as before: [object Promise] may interact with the parties of role [object Promise].&lt;/p&gt;
[object Promise]&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The extension for [object Promise] is simple: since we are projecting with respect to [object Promise], we can just check if an occurrence of communication involves [object Promise] directly. If it involves [object Promise] as both sender and receiver, we correspondingly produce both [object Promise] and [object Promise].&lt;/p&gt;
&lt;!-- &lt;details&gt; --&gt;
&lt;!-- &lt;summary&gt; --&gt;
&lt;p&gt;Let&#39;s walk through an example.&lt;/p&gt;
&lt;!-- &lt;/summary&gt; --&gt;
[object Promise]&lt;p&gt;The type in (1) represents a protocol where every party in role [object Promise] pings every other, sending a message and receiving a reply.&lt;/p&gt;
&lt;p&gt;In (2), [object Promise] could be in [object Promise], so we apply [object Promise] case 1.
In the left arm, we push the projection inward until we are able to project the communication into a [object Promise] (4).
In the right arm, we add [object Promise] to the set of exclusions for the quantifier for [object Promise] and continue (3), but since [object Promise] may also be [object Promise], we find ourselves having to apply case 1 again (4).
The left arm there projects to a receive (5), while the right is a no-op, as the communication between [object Promise] and [object Promise] is unobservable to [object Promise].
This gives us the protocol at (6), which says exactly what we started out with.&lt;/p&gt;
&lt;!-- &lt;/details&gt; --&gt;
&lt;!-- &lt;br&gt; --&gt;
&lt;!-- why reproduce this example? it fixes typos in the paper and comes with more explanation and detail, without skipping steps --&gt;
&lt;p&gt;The title of the paper mentioned earlier should make sense now.
Protocols with self-sends and universal quantification are &amp;quot;multirole&amp;quot; because parties may act as both sender and receiver, and have two distinct classes of behaviors.&lt;/p&gt;
&lt;p&gt;The paper uses &amp;quot;dynamic&amp;quot; in the sense that parties can join and leave, and the [object Promise] thus specifies the behavior of a possibly infinite set of parties. We aren&#39;t (yet?) concerned with this aspect.
We are, however, concerned with two different senses of &amp;quot;dynamic&amp;quot;, which is that roles may be &lt;em&gt;computed&lt;/em&gt; in the course of the protocol, or dynamic changes; we return to this shortly.&lt;/p&gt;
&lt;h1 id=&quot;choreographic-pluscal&quot;&gt;Choreographic PlusCal&lt;/h1&gt;
&lt;p&gt;This is the heart of the projection function that is implemented in &lt;a href=&quot;https://dariusf.github.io/cpluscal&quot;&gt;Choreographic PlusCal&lt;/a&gt;, a choreographic specification language I worked on.&lt;/p&gt;
&lt;p&gt;It brings the succinctness and clarity of session types to a much more expressive specification language, one which scales up to real-world distributed protocols, which compute and branch, and are much closer to algorithms than sequences of transmissions.&lt;/p&gt;
&lt;p&gt;The tradeoff is that Choreographic PlusCal models cannot be verified by simple type checking.
Even properties such as deadlock-freedom cannot be guaranteed with things like &lt;code&gt;await FALSE;&lt;/code&gt; in the language.
Fortunately, being a PlusCal dialect, it has access to TLC, making it a very practical point in the design space.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Jump-to-definition in PL papers</title>
    <link href="https://dariusf.github.io/blog/latex-notation/" />
    <updated>2023-08-01T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/latex-notation/</id>
    <content type="html">&lt;p&gt;PL papers tend to use lots of &lt;a href=&quot;https://www.jsoftware.com/papers/tot.htm&quot;&gt;notation&lt;/a&gt;.
To manage this, paper sources usually include a &amp;quot;macros.tex&amp;quot; containing a slew of &lt;code&gt;&#92;newcommand&lt;/code&gt;s, defining wonderful languages of terms and naming all the clever judgments and syntactic sugar.&lt;/p&gt;
&lt;p&gt;While notation can increase clarity, it can cause &lt;a href=&quot;https://blog.sigplan.org/2020/09/29/pl-notation-is-a-barrier-to-entry/&quot;&gt;difficulty&lt;/a&gt; to readers, who
haven&#39;t had the hundreds of hours of practice the authors have had using and reading those intricate strings of symbols, and internalizing their precedences and meaning.
Readers will forget what things denote and will have to scroll up and down repeatedly in a careful reading of the work.&lt;/p&gt;
&lt;p&gt;In an attempt to alleviate this and make my work more accessible, I&#39;ve been using a small set of macros to enable jump-to-definition for the important (or obscure) symbols:&lt;/p&gt;
&lt;!-- &#92;usepackage[hidelinks]{hyperref} also works --&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;% somewhere above&lt;/span&gt;
&lt;span class=&quot;token function selector&quot;&gt;&#92;usepackage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;colorlinks=true&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;hyperref&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;% meta-commands for defining notation&lt;/span&gt;
&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notationlink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;hyperlink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;normalcolor&lt;/span&gt; #2&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notationtarget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;hypertarget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;#2&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;%&lt;/span&gt;
  &lt;span class=&quot;token function selector&quot;&gt;&#92;expandafter&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;csname&lt;/span&gt; #1&lt;span class=&quot;token function selector&quot;&gt;&#92;endcsname&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notationlink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#2&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;%&lt;/span&gt;
  &lt;span class=&quot;token function selector&quot;&gt;&#92;expandafter&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;csname&lt;/span&gt; #1Def&lt;span class=&quot;token function selector&quot;&gt;&#92;endcsname&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notationtarget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The idea is to link uses of notation to their definitions. All that&#39;s really needed for that is to pepper &lt;code&gt;&#92;hyperlink&lt;/code&gt; and &lt;code&gt;&#92;hypertarget&lt;/code&gt; everywhere, and this is what people &lt;a href=&quot;https://damaru2.github.io/general/notations_with_links/&quot;&gt;already do&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We can be a little more structured. First, for macros.tex enjoyers, we&#39;ll use the command &lt;code&gt;&#92;notation&lt;/code&gt; to define a new symbol, so all the definitions can go in one place. For example,&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;trace&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;tau&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This defines the command &lt;code&gt;&#92;trace&lt;/code&gt; as a macro for &lt;code&gt;&#92;tau&lt;/code&gt;.
More importantly, it defines the paired command &lt;code&gt;&#92;traceDef&lt;/code&gt;, which is used to mark the definition site of this symbol, and which every occurrence of &lt;code&gt;&#92;trace&lt;/code&gt; unobtrusively links to.&lt;/p&gt;
&lt;p&gt;For example, having written this,&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;A &lt;span class=&quot;token function selector&quot;&gt;&#92;emph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;trace&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token equation string&quot;&gt;$&lt;span class=&quot;token equation-command regex&quot;&gt;&#92;trace&lt;/span&gt;$&lt;/span&gt; is a sequence of states...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;simply include &lt;code&gt;&#92;traceDef&lt;/code&gt; nearby:&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;A &lt;span class=&quot;token function selector&quot;&gt;&#92;traceDef&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;emph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;trace&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token equation string&quot;&gt;$&lt;span class=&quot;token equation-command regex&quot;&gt;&#92;trace&lt;/span&gt;$&lt;/span&gt; is a sequence of states...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Subsequent uses of &lt;code&gt;&#92;trace&lt;/code&gt; (even the one right after) will now contain links back to this part of the paper.&lt;/p&gt;
&lt;p&gt;Doing this has benefits for authors too.
The introduction of a new concept is now made explicit, which may help you consider if you&#39;re doing a &amp;quot;forward definition&amp;quot;;
if you forget the definition, you get a compilation warning.
Furthermore, paired with SyncTex, you can really zip around the paper.&lt;/p&gt;
&lt;p&gt;For an example of this in action, I&#39;ve annotated my most recent paper &lt;a href=&quot;https://arxiv.org/abs/2308.00988&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The amount of effort was very low for the value – it&#39;s very much pay-as-you-go, and easy to do while proofreading.
To prioritize, focus on important notations first (which readers will frequently have to refer back to), then obscure ones or those with a large distance to their definitions.&lt;/p&gt;
&lt;!-- Of course, all this only helps if it goes on top of focused effort to simplify and standardize your notation. --&gt;
&lt;!-- Read on for a discussion of the [design](#design-decisions) and more advanced [use cases](#more-use-cases). --&gt;
&lt;h1 id=&quot;design-decisions&quot;&gt;Design decisions&lt;/h1&gt;
&lt;details&gt;&lt;summary&gt;Why don&#39;t both commands take any parameters?&lt;/summary&gt;
&lt;p&gt;For &lt;code&gt;&#92;traceDef&lt;/code&gt;, it&#39;s so it can be placed anywhere, alongside what is written. To repeat the example from before:&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;A &lt;span class=&quot;token function selector&quot;&gt;&#92;traceDef&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;emph&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;trace&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token equation string&quot;&gt;$&lt;span class=&quot;token equation-command regex&quot;&gt;&#92;trace&lt;/span&gt;$&lt;/span&gt; is a sequence of states...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;On the other hand, &lt;code&gt;&#92;trace&lt;/code&gt; taking no argument may seem like a deficiency: how should we replace a &lt;code&gt;&#92;newcommand&lt;/code&gt; with parameters?&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;bigstep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;3&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token function selector&quot;&gt;&#92;leadsto&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#2&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;#3&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;% what&#39;s the &#92;notation equivalent?&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;% a use&lt;/span&gt;
We define the relation &lt;span class=&quot;token function selector&quot;&gt;&#92;bigstep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;trace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; as follows...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The reason is that we seldom want the entire term to become a link: it&#39;s possible we want to introduce notation for subterms, like the metavariable &lt;code&gt;e&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;My suggested way forward is to define notation for some essential symbol in the term, then use it in the definition of the term macro.&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;bigstepto&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;leadsto&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;bigstep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;3&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token function selector&quot;&gt;&#92;bigstepto&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#2&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;#3&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

We define the relation &lt;span class=&quot;token function selector&quot;&gt;&#92;bigsteptoDef&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;bigstep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;trace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; as follows...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This way, which portion becomes a link is always well-defined, and there is no problem with nesting notations.&lt;/p&gt;
&lt;/details&gt;
&lt;details&gt;&lt;summary&gt;Could we instrument &lt;code&gt;&#92;newcommand&lt;/code&gt;?&lt;/summary&gt;
&lt;p&gt;I briefly entertained the idea of instrumenting &lt;code&gt;&#92;newcommand&lt;/code&gt; to automate defining notations.
However, &lt;code&gt;&#92;newcommand&lt;/code&gt; is used for all kinds of things, not just definitions.
We would also have to handle the case of a command having parameters (see previous point).&lt;/p&gt;
&lt;/details&gt;
&lt;details&gt;&lt;summary&gt;Could we automatically link to the first use?&lt;/summary&gt;
&lt;p&gt;An early version of this defined a command that redefined itself after the first time it was used, so subsequent uses would link back to the first one.
This seemed like a nice idea, based on the assumption that &amp;quot;forward definitions&amp;quot; should be avoided.&lt;/p&gt;
&lt;p&gt;However, this can be fragile when used with figures, which may end up ordered before any given text on a page, and it is sometimes natural to defer a formal definition until after an intuitive use has been explained.&lt;/p&gt;
&lt;p&gt;The current simpler design, relying on manual annotation of the definition site, seems more robust.&lt;/p&gt;
&lt;/details&gt;
&lt;h1 id=&quot;more-use-cases&quot;&gt;More use cases&lt;/h1&gt;
&lt;p&gt;It&#39;s sometimes useful to use the lower-level &lt;code&gt;&#92;notationlink&lt;/code&gt; and &lt;code&gt;&#92;notationtarget&lt;/code&gt; directly.
For example, say you typeset the names of inference rules in a special font.&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;rulen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;ensuremath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;bf&lt;/span&gt; &lt;span class=&quot;token function selector&quot;&gt;&#92;scriptstyle&lt;/span&gt; #1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can instrument it so that it adds a link, and define another variant for introducing a definition, which you then use in your inference rule.&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;rulen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notationlink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;ensuremath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;bf&lt;/span&gt; &lt;span class=&quot;token function selector&quot;&gt;&#92;scriptstyle&lt;/span&gt; #1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;defrulen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;1&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notationtarget&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;ensuremath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;bf&lt;/span&gt; &lt;span class=&quot;token function selector&quot;&gt;&#92;scriptstyle&lt;/span&gt; #1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you have a mixfix judgment and want all the parts around the arguments to be links, adding an extra &lt;code&gt;&#92;notationlink&lt;/code&gt; is the easiest way to achieve this.&lt;/p&gt;
&lt;pre class=&quot;language-latex&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-latex&quot;&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;notation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;smodels&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;models&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function selector&quot;&gt;&#92;newcommand*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;bigstep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;3&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;#1&lt;span class=&quot;token function selector&quot;&gt;&#92;smodels&lt;/span&gt; #2 &lt;span class=&quot;token function selector&quot;&gt;&#92;notationlink&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;smodels&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function selector&quot;&gt;&#92;leadsto&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; #3&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It may occasionally be helpful to explicate all uses and definitions, either to look for unlinked ones, or to ensure that definition sites are where you think they should be.
This can be done by simply removing the unobtrusive link colour and adding &lt;code&gt;&#92;fbox{#1Def}&lt;/code&gt; before &lt;code&gt;&#92;notationlink&lt;/code&gt; in the &lt;code&gt;&#92;notation&lt;/code&gt; macro above.&lt;/p&gt;
&lt;!--

[^2]: [This paper](https://arxiv.org/abs/2006.11639) is an example in the wild where the authors underline newly-introduced terms.

Anchoring the definition to a specific word could also be done. A common convention is to italicise words, so authors could define:

```latex
&#92;newcommand*{&#92;firstuse}[1]{%
  &#92;traceDef&#92;emph{}}
```

it seems better not to make that choice and leave it to authors to define in a derived macro.

, e.g. `&#92;traceDef{&#92;emph{trace}}`, isn&#39;t much of an improvement. Also, the way in which notation is introduced is highly varied[^1][^2], so further structure seems counterproductive.

[^1]: One could further codify this convention of italicising introduced terms:

    ```latex
    &#92;newcommand*{&#92;firstuse}[1]{%
      &#92;expandafter{&#92;csname #1Def&#92;endcsname}&#92;emph{#1} &#92;ensuremath{&#92;csname #1&#92;endcsname}}
    ```
    
    though in practice it&#39;s not often that the command name, the typeset content, and the way in which the symbol is introduced all coincide.

Not everything is introduced in a formal definition. Stuff implicitly like in a grammar saying x is a var without any other notation than just writing the nonterminal

Going even further generating an index
this is the point at which it starts to become yak shaving, but why not

Statements. Takes this idea to its conclusion. Might be a bit too heavyweight for people. If you want something lighter this is it


https://ctan.math.washington.edu/tex-archive/macros/latex/contrib/stex/sty/statements/statements.pdf

https://tex.stackexchange.com/questions/271745/link-to-definition-for-each-command-in-mathmode

https://www.overleaf.com/learn/latex/Indices

https://tex.stackexchange.com/questions/150849/a-command-to-define-other-commands-with-arguments


latex blog post

- this
    ```&#92;
    sd &#39;&#92;&#92;newcommand&#92;*&#92;{&#92;&#92;([^}]*)&#92;}&#92;{(.*)&#92;}&#39; &#39;&#92;&#92;newsdefinition{$1}{$2}&#39; macros.tex
    sd &#39;&#92;&#92;newcommand&#92;*&#92;{&#92;&#92;([^}]*)&#92;}&#92;{(.*)&#92;}&#39; &#39;&#92;&#92;notation{$1}{$2}&#39; macros.tex
    ```
- clean up lol.tex
- redefining cmds https://tex.stackexchange.com/questions/71092/automatic-species-names-in-latex-command-that-does-something-differently-the-s
- https://tex.stackexchange.com/questions/104023/what-is-a-token
- https://tex.stackexchange.com/questions/556915/why-do-i-have-to-put-braces-around-my-macro-for-subscripts-indices
- commits in paper repo
- write the post
- New command star
- https://www.overleaf.com/learn/latex/Glossaries


% &#92;notation{trace}{&#92;tau} 

% A &#92;firstuse{trace}{trace} $&#92;trace$ is a sequence of states...

% &#92;newcommand*{&#92;zz}[0]{res}

% In the interest of simplicity, no syntax is provided for instrumenting/wrapping &#92;newcommand.
% The idea is to use this to define terminals, then use the terminals in other macros, so just one part of. It&#39;s also unlikely you want the entire syntax to be highlighted, e.g. if you define a judgement A,B,C |= phi ~&gt; D,E,F, this would allow you to make only (say) the ~&gt; a link. But then again you probably don&#39;t want the entire thing to be made into a link. if A is a metavariable it to be a link to where it is first introduced.

% TODO
% newcommand*


% https://tex.stackexchange.com/questions/445597/how-to-link-to-the-references-in-the-definition
% https://damaru2.github.io/general/notations_with_links/


% https://tex.stackexchange.com/questions/521254/how-to-use-csname-to-call-a-command-with-an-argument
% https://tex.stackexchange.com/questions/302308/defining-a-command-to-define-an-asterisk-command
% https://tex.stackexchange.com/questions/73271/how-to-redefine-or-patch-the-newcommand-command
% https://tex.stackexchange.com/questions/287657/learning-to-use-xparse

% an earlier version found the first use and marked it. but this is fragile because for example, a figure might appear above the definition
% firstuse -&gt; definition?

% can use incrementlly. don&#39;t have to define first use. though a bit pointless without

--&gt;</content>
  </entry>
  <entry>
    <title>Ordering events across live loops in Sonic Pi</title>
    <link href="https://dariusf.github.io/blog/sonic-pi-time/" />
    <updated>2023-06-03T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/sonic-pi-time/</id>
    <content type="html">&lt;p&gt;Sonic Pi has an elegant and well-thought &lt;a href=&quot;https://in-thread.sonic-pi.net/t/what-does-time-mean-in-sonic-pi/4509&quot;&gt;temporal semantics&lt;/a&gt;. Using the following program as an example,&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;sample &lt;span class=&quot;token symbol&quot;&gt;:drum_bass_hard&lt;/span&gt;
play &lt;span class=&quot;token symbol&quot;&gt;:c&lt;/span&gt;
sleep &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
sample &lt;span class=&quot;token symbol&quot;&gt;:drum_cowbell&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The drum sample and note can be thought of as starting simultaneously, and the cowbell will play precisely one second&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/sonic-pi-time/#fn1&quot; id=&quot;fnref1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; after.
In other words, &lt;code&gt;sleep&lt;/code&gt; there isn&#39;t actually POSIX&#39;s &lt;code&gt;sleep&lt;/code&gt; - it can be thought of as delimiting a section on a virtual timeline, a section which &lt;em&gt;does not include the time taken to start playing the sample and note&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;This enables a simple and declarative programming model.
Setting up two live loops like the following works as you would expect, i.e. they won&#39;t drift out of sync. If the sound card is overloaded, some sounds may not play, but live loops will remain in phase.&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;live_loop &lt;span class=&quot;token symbol&quot;&gt;:hihat&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  sample &lt;span class=&quot;token symbol&quot;&gt;:drum_cymbal_closed&lt;/span&gt;
  sleep &lt;span class=&quot;token number&quot;&gt;0.25&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

live_loop &lt;span class=&quot;token symbol&quot;&gt;:drums&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  sample &lt;span class=&quot;token symbol&quot;&gt;:drum_bass_hard&lt;/span&gt;
  sleep &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Well, mostly.
Live loops are Ruby threads, which are scheduled nondeterministically. As a result, events across threads within one time &amp;quot;partition&amp;quot; are unordered.&lt;/p&gt;
&lt;p&gt;Consider this simplified example, which features communication across live loops. It&#39;s a fairly common scenario: we have a control loop that determines the key we&#39;re playing in, and one or more loops which adapt accordingly.&lt;/p&gt;
&lt;p&gt;We&#39;re using &lt;code&gt;set&lt;/code&gt; and &lt;code&gt;get&lt;/code&gt; for deterministic (timeline-synced) state updates, and the &lt;code&gt;sync:&lt;/code&gt; parameter to ensure that &lt;code&gt;melody&lt;/code&gt; only starts when receiving a  &lt;em&gt;cue&lt;/em&gt; from &lt;code&gt;control&lt;/code&gt;. Cues are sent every time a live loop begins executing its block.&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;live_loop &lt;span class=&quot;token symbol&quot;&gt;:control&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  set &lt;span class=&quot;token symbol&quot;&gt;:n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token symbol&quot;&gt;:c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:d&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:e&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tick
  sleep &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

live_loop &lt;span class=&quot;token symbol&quot;&gt;:melody&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:control&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  play &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;get &lt;span class=&quot;token symbol&quot;&gt;:n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  sleep &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We observe two surprising things.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The first note we hear is always &lt;code&gt;:d&lt;/code&gt;, and always after a second of silence&lt;/li&gt;
&lt;li&gt;The notes thereafter are some random subsequence of the ring &lt;code&gt;[:c, :d, :e]&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The &lt;a href=&quot;https://in-thread.sonic-pi.net/t/live-loops-sync-questions/1172/13&quot;&gt;fix&lt;/a&gt; for the first issue is to make the control loop start after a short delay.&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;live_loop &lt;span class=&quot;token symbol&quot;&gt;:control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  set &lt;span class=&quot;token symbol&quot;&gt;:n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token symbol&quot;&gt;:c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:d&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:e&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tick
  sleep &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This happens because of Ruby&#39;s imperative nature and nondeterministic thread scheduling: when the first live loop starts executing in a thread, the cue it subsequently sends is unordered with respect to the second &lt;code&gt;live_loop&lt;/code&gt; call (which executes on the main thread). Most of the time the cue is sent before the melody loop starts, causing it to miss playing the first note.
Thus the cue should be delayed until after the melody loop has (presumably&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/sonic-pi-time/#fn2&quot; id=&quot;fnref2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;) started.&lt;/p&gt;
&lt;!-- The referenced forum thread contains a neat metaphor: musicians in a real-life orchestra should all be ready before the conductor gives them the cue start playing. Software does allow us to do better, however... --&gt;
&lt;p&gt;To address the second issue of notes missing, we could remove the &lt;code&gt;sync:&lt;/code&gt; parameter and try using &lt;code&gt;sync&lt;/code&gt; instead of &lt;code&gt;get&lt;/code&gt;, which makes melody loop wait for the &lt;a href=&quot;https://in-thread.sonic-pi.net/t/a-tiny-script-for-your-hipster-lounge/4448/10&quot;&gt;next&lt;/a&gt; note.&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;live_loop &lt;span class=&quot;token symbol&quot;&gt;:melody&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  play &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync &lt;span class=&quot;token symbol&quot;&gt;:n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  sleep &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, however, we hear only every other note.
The problem is that it is possible for the melody loop to miss cues while it is sleeping. I&#39;m not sure if this is due to the time abstraction leaking (where we can observe one thread sleeping while another acts, despite the time &amp;quot;partition&amp;quot; being the same), or the ordering of cues not being well-defined with respect to other events in live loops.&lt;/p&gt;
&lt;p&gt;Nevertheless, the solution is to ensure that the melody loop is not asleep when control loop cues. A simple way is to make sure there is always less sleep time in the former loop.&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;live_loop &lt;span class=&quot;token symbol&quot;&gt;:control&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  set &lt;span class=&quot;token symbol&quot;&gt;:n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token symbol&quot;&gt;:c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:d&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:e&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tick
  sleep &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

live_loop &lt;span class=&quot;token symbol&quot;&gt;:melody&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  play &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sync &lt;span class=&quot;token symbol&quot;&gt;:n&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# we can do other things here, as long as we sleep &amp;lt; 1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;These are awfully subtle issues for beginners to debug.
I wish Sonic Pi had a simpler, more synchronous concurrency model, or at least provided more guarantees about the interleaving of events within a time partition.
It&#39;s quite likely that this is difficult to implement efficiently with its wealth of features, though.&lt;/p&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;One beat, actually, but at the default BPM of 60, one beat occurs every second. &lt;a href=&quot;https://dariusf.github.io/blog/sonic-pi-time/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;Technically we&#39;re still not guaranteed that the second loop has started. &lt;a href=&quot;https://dariusf.github.io/blog/sonic-pi-time/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
  </entry>
  <entry>
    <title>Trees with holes</title>
    <link href="https://dariusf.github.io/blog/trees-with-holes/" />
    <updated>2022-05-16T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/trees-with-holes/</id>
    <content type="html">&lt;p&gt;While working on a top-down synthesis prototype, I got distracted by the issue of how to represent incomplete program fragments, with holes to be filled in.&lt;/p&gt;
&lt;p&gt;The simple way:&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; expr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; One
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Plus &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; expr &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; expr
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Hole

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Hole

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; hypothesis &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; __&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and this would probably have worked, but with quadratic-time substitution, since all the holes would be at the bottom of the tree.&lt;/p&gt;
&lt;p&gt;How could we do better?&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/trees-with-holes/#fn1&quot; id=&quot;fnref1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;h2 id=&quot;difference-lists&quot;&gt;Difference lists&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikibooks.org/wiki/Prolog/Difference_Lists&quot;&gt;Difference lists&lt;/a&gt; originate in Prolog folklore.&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/trees-with-holes/#fn2&quot; id=&quot;fnref2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;
Unlike regular lists, they end with a logic variable instead of an empty list.
When unified, the logic variable allows something to be appended to the list quickly, without rebuilding it.&lt;/p&gt;
&lt;!--
https://swi-prolog.discourse.group/t/difference-list/959
--&gt;
&lt;pre&gt;&lt;code&gt;?- A = ([1,2|E],E), E = [3,4].
A =  ([1, 2, 3, 4], [3, 4]),
E = [3, 4].
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The same idea works in functional languages:
a list like &lt;code&gt;[1; 2]&lt;/code&gt; can be represented as the function &lt;code&gt;(fun x -&amp;gt; 1 :: 2 :: x)&lt;/code&gt;.
Appending two lists is function composition, and once we apply the difference list to &lt;code&gt;[]&lt;/code&gt; to recover a regular list, we only incur the cost of building it once, regardless of how the difference list was constructed. &lt;a href=&quot;https://github.com/batsh-dev-team/Dlist&quot;&gt;Here&lt;/a&gt; is an implementation where you can see how other list operations are implemented.&lt;/p&gt;
&lt;!--
http://requestforlogic.blogspot.com/2011/08/holey-data-part-13-almost-difference.html

A Functional Representation of Data Structures with a Hole
--&gt;
&lt;p&gt;What would work for us is a difference list with a variable number of holes that don&#39;t all appear at the end.&lt;/p&gt;
&lt;h2 id=&quot;difference-trees&quot;&gt;Difference trees&lt;/h2&gt;
&lt;p&gt;First, the type of our difference tree.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; int &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expr list &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; expr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;(* Plus (One, __) *)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; example &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;One&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We now have a list of holes to fill, and we keep track of how many there are, since otherwise that information would be known only upon building the tree.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; concretize &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; expr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  t &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;init i &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Hole&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finally, the main operation of substituting &lt;em&gt;difference trees&lt;/em&gt; into difference trees.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; sub dts &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length dts &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; f r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; _rem&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; trees &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
      List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fold_right
        &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ct&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; used&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; rem &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;take_drop i tr &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rem&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ct used &lt;span class=&quot;token punctuation&quot;&gt;::&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        dts &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
    t trees
  &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; dts_arities &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fold_right &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dts &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dts_arities&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If we substitute two trees with m and n holes into another with just two holes, the resulting tree should have (m + n) holes.
Furthermore, the holes &lt;code&gt;r&lt;/code&gt; of the resulting tree &lt;code&gt;f&lt;/code&gt; should be distributed amongst the child trees according to their arities.&lt;/p&gt;
&lt;p&gt;We try a few examples and...&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; One&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;One&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;e1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; e2&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; c&#39; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; concretize &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sub &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;#&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;;;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expr list &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; expr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;#&lt;/span&gt; c&#39;&lt;span class=&quot;token punctuation&quot;&gt;;;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; expr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Hole&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; One&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;One&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Hole&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;... it works! A wrinkle is that we had to keep the &lt;code&gt;Hole&lt;/code&gt; constructor around to be able to render the tree.&lt;/p&gt;
&lt;h2 id=&quot;partial-application&quot;&gt;Partial application&lt;/h2&gt;
&lt;p&gt;Holes are usually filled one by one, and it&#39;d be nice if we didn&#39;t have to store all the arguments somewhere before using them.
We can extend substitution so that not all arguments have to be supplied upfront, and the remaining holes are preserved in the new tree.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; sub dts &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length dts &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; dts_arities &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fold_right &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; dts &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; remaining &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length dts &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; f r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length r &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; dts_arities &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; remaining&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; rem_trees&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;take_drop remaining r &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; _rem&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; child_trees &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
      List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fold_right
        &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ct&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; used&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; rem &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;take_drop i tr &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rem&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ct used &lt;span class=&quot;token punctuation&quot;&gt;::&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        dts &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
    t &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;child_trees &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt; rem_trees&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dts_arities &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; remaining&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; f&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This version is rather subtle: given a difference tree &lt;code&gt;(i, t)&lt;/code&gt;, it produces another difference tree which knows how to rearrange its arguments so the complete application of &lt;code&gt;(i, t)&lt;/code&gt; occurs (which is why we didn&#39;t have to handle partial application of child trees).
It also ensures that all the holes of parent trees are filled before those of child trees.&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/trees-with-holes/#fn3&quot; id=&quot;fnref3&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;p&gt;Now we&#39;re able to supply arguments to &lt;code&gt;c&lt;/code&gt; one at a time:&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; c&#39; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; concretize &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sub &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sub &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;#&lt;/span&gt; c&#39;&lt;span class=&quot;token punctuation&quot;&gt;;;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; expr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Hole&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; One&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;One&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Hole&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;representing-holes-statically&quot;&gt;Representing holes statically?&lt;/h2&gt;
&lt;p&gt;Having to write the arity separately when it could be given in the type of the function is another wrinkle.
We could try to use a GADT to &lt;a href=&quot;https://drup.github.io/2016/08/02/difflists/&quot;&gt;constrain&lt;/a&gt; the holes.
First, a type for the number of holes that a difference tree contains.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; z &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Z
&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;token type-variable function&quot;&gt;&#39;a&lt;/span&gt; s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; S &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;token type-variable function&quot;&gt;&#39;a&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; holes &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; S &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token type-variable function&quot;&gt;&#39;a&lt;/span&gt; holes &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expr &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token type-variable function&quot;&gt;&#39;a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; holes
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Z &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; expr holes

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;token type-variable function&quot;&gt;&#39;a&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token type-variable function&quot;&gt;&#39;a&lt;/span&gt; holes &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token type-variable function&quot;&gt;&#39;a&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The arity of the function is now determined by the number of holes.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; a &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expr &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; expr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S Z&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; e &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; One&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expr &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; expr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S Z&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; e &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;One&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; c &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expr &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; expr &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; expr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S Z&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; e1 e2 &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Plus &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;e1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can even write &lt;code&gt;concretize&lt;/code&gt;, using a locally abstract type, and pattern-matching on the number of holes remaining.&lt;/p&gt;
&lt;pre class=&quot;language-ocaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;rec&lt;/span&gt; concretize &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; a t &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; expr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; S i &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; concretize &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t Hole&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Z &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; t&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Unfortunately that was as far as I was able (and motivated) to go: it&#39;s unclear to me how to build an &lt;code&gt;f&lt;/code&gt; with a number of arguments that depends on &lt;code&gt;(i, t)&lt;/code&gt;, even if we change &lt;code&gt;dts&lt;/code&gt; from a list to a single argument.
Even if we overcame that, all the folding and rearranging of arguments would certainly cause difficulty down the line.&lt;/p&gt;
&lt;h2 id=&quot;hoas&quot;&gt;HOAS?&lt;/h2&gt;
&lt;p&gt;This is a much more coarse-grained notion of binding than what, say, &lt;a href=&quot;https://github.com/rlepigre/ocaml-bindlib&quot;&gt;bindlib&lt;/a&gt; implements, so if your trees have not just holes but free variables, or even binders lower in the tree instead of all at the top, definitely check that out.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Code &lt;a href=&quot;https://gist.github.com/dariusf/f22f9c121e42f5bb9c2c85520baaba52&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;Ignoring the fact that our goal with top-down synthesis is not to let the trees get too large... &lt;a href=&quot;https://dariusf.github.io/blog/trees-with-holes/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://www.cs.cmu.edu/~fp/courses/lp/lectures/11-diff.pdf&quot;&gt;Difference Lists&lt;/a&gt;, section 11.6 &lt;a href=&quot;https://dariusf.github.io/blog/trees-with-holes/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;This is currently the only order we can perform substitutions in. We could allow skipping arguments positionally using a placeholder difference tree value, or some (dynamic) way to address holes. &lt;a href=&quot;https://dariusf.github.io/blog/trees-with-holes/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
  </entry>
  <entry>
    <title>Visualizing Z3&#39;s proofs</title>
    <link href="https://dariusf.github.io/blog/z3-proofs/" />
    <updated>2021-03-21T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/z3-proofs/</id>
    <content type="html">&lt;p&gt;&lt;em&gt;A writeup of a presentation I gave in class.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;SMT solvers like Z3 are often also called automated theorem provers. Why? What do their proofs look like?&lt;/p&gt;
&lt;p&gt;An SMT solver tells us if a formula in first-order logic (augmented with various theories) is &lt;em&gt;satisfiable&lt;/em&gt;&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/z3-proofs/#fn1&quot; id=&quot;fnref1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;: there is some assignment of variables that makes the formula true. Z3 can even produce such an assignment.&lt;/p&gt;
&lt;pre class=&quot;language-python&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; z3 &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;

i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Int&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;i&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
solve&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-python&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Not every formula is satisfiable, though. In that case, there are two possibilities.&lt;/p&gt;
&lt;p&gt;Z3 can say &lt;code&gt;unknown&lt;/code&gt;. This is the less interesting one. It means that Z3 ran out of time or memory, or the algorithm it uses to find the assignment is incomplete, or the problem itself is unsolvable in general. In other words, we don&#39;t know for sure if an assignment does not exist.&lt;/p&gt;
&lt;!-- https://stackoverflow.com/questions/11197344/z3-produces-unknown-for-assertions-without-quantifiers --&gt;
&lt;p&gt;The other outcome is &lt;code&gt;unsat&lt;/code&gt;.
This is a much stronger statement than satisfiability, as it means that &lt;em&gt;every&lt;/em&gt; assignment of variables must not work.&lt;/p&gt;
&lt;p&gt;This has something of the flavour of proving a theorem, where we aim to convince ourselves that a formula is true for &lt;em&gt;every&lt;/em&gt; assignment of variables.&lt;/p&gt;
&lt;p&gt;We can connect these two views by expressing the theorem we want to prove instead as the non-existence of a &lt;em&gt;refutation&lt;/em&gt;, or counterexample, to it.
We do this by negating the formula and asking, &amp;quot;is it possible that there is some way for this formula not to be true?&amp;quot;
&lt;code&gt;unsat&lt;/code&gt; means no, i.e. the theorem is always true.&lt;/p&gt;
&lt;h2 id=&quot;z3s-proofs&quot;&gt;Z3&#39;s proofs&lt;/h2&gt;
&lt;p&gt;Z3 has facilities for explaining its deductions, in the form of proofs.
Let&#39;s try them on a really simple theorem, [object Promise].&lt;/p&gt;
&lt;!-- https://stackoverflow.com/questions/49874498/can-i-replay-a-proof-in-z3 --&gt;
&lt;pre class=&quot;language-python&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; z3 &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;

set_param&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;proof&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Solver&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Bool&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; a
s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;add&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Not&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;f&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;check&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;res&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; res &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; sat&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;model&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  p &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;proof&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Something to note that is that variables in SMT are implicitly existentially quantified. Therefore we are searching for a counterexample by seeing if [object Promise] is satisfiable.&lt;/p&gt;
&lt;pre class=&quot;language-python&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;unsat
mp&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;asserted&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Not&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   trans&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;monotonicity&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rewrite&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                      Not&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; Not&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
         rewrite&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Not&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
         Not&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Unsurprisingly, it is not.
Z3 outputs a &lt;em&gt;proof tree&lt;/em&gt;, which we can traverse and pretty-print.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/eCd6ZZJBEd-964.avif 964w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/eCd6ZZJBEd-964.webp 964w&quot;&gt;&lt;img loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://dariusf.github.io/blog/z3-proofs/eCd6ZZJBEd-964.png&quot; class=&quot;theme-affected&quot; alt=&quot;first pretty-printed proof tree&quot; width=&quot;964&quot; height=&quot;156&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;Firstly, we see that the conclusion at the bottom is &lt;code&gt;False&lt;/code&gt;.
This may seem odd, but recall that the goal is to show that negation of the original theorem cannot be proved, so this is the only conclusion which makes sense.&lt;/p&gt;
&lt;p&gt;Next, we see some of Z3&#39;s inference rules&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://dariusf.github.io/blog/z3-proofs/#fn2&quot; id=&quot;fnref2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt; in action.
Our original goal is &lt;code&gt;asserted&lt;/code&gt;.
We have two instances of &lt;code&gt;rewrite&lt;/code&gt;, where built-in equalities are used to simplify terms.
There is an application of &lt;code&gt;monotonicity&lt;/code&gt;, where we negate both sides.
Finally we use the &lt;code&gt;trans&lt;/code&gt;itivity of equality and modus ponens to derive the conclusion.&lt;/p&gt;
&lt;p&gt;Let&#39;s try [object Promise].&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/HV6aMLnxj0-1743.avif 1743w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/HV6aMLnxj0-1743.webp 1743w&quot;&gt;&lt;img loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://dariusf.github.io/blog/z3-proofs/HV6aMLnxj0-1743.png&quot; class=&quot;theme-affected&quot; alt=&quot;another proof tree&quot; width=&quot;1743&quot; height=&quot;290&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;And here&#39;s another for the linear arithmetic formula [object Promise].&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/8PuYupz8iZ-2726.avif 2726w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/8PuYupz8iZ-2726.webp 2726w&quot;&gt;&lt;img loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://dariusf.github.io/blog/z3-proofs/8PuYupz8iZ-2726.png&quot; class=&quot;theme-affected&quot; alt=&quot;linear arithmetic formula proof, overwhelming detail&quot; width=&quot;2726&quot; height=&quot;165&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;Clearly, these generated proofs quickly get too large to be comprehensible.
They&#39;re also largely mechanical and not very meaningful.
Still, it&#39;s intriguing to see the automated reasoning that Z3 performs.&lt;/p&gt;
&lt;p&gt;A final point about the last one is the application of the rule &lt;code&gt;th-lemma&lt;/code&gt; to derive the conclusion.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/92fQ8tuCpw-489.avif 489w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://dariusf.github.io/blog/z3-proofs/92fQ8tuCpw-489.webp 489w&quot;&gt;&lt;img loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://dariusf.github.io/blog/z3-proofs/92fQ8tuCpw-489.png&quot; class=&quot;theme-affected&quot; alt=&quot;theory lemma&quot; width=&quot;489&quot; height=&quot;59&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;This is a theory lemma, a placeholder rule for a possibly-opaque decision from a theory solver.&lt;/p&gt;
&lt;p&gt;If you want to generate these proofs yourself, the code is &lt;a href=&quot;https://gist.github.com/dariusf/1fbb17816bea7417e4a104d58d2053d8&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;For a more thorough introduction to satisfiability, check out &lt;a href=&quot;https://homes.cs.washington.edu/~emina/blog/2017-06-23-a-primer-on-sat.html#satisfiability-and-validity&quot;&gt;this blog post&lt;/a&gt;. &lt;a href=&quot;https://dariusf.github.io/blog/z3-proofs/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;There&#39;s a more complete list of rules in Section 3.3 of &lt;a href=&quot;https://www21.in.tum.de/~boehmes/proofrec.pdf&quot;&gt;this paper&lt;/a&gt;. &lt;a href=&quot;https://dariusf.github.io/blog/z3-proofs/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
  </entry>
  <entry>
    <title>Pretty stack-and-heap diagrams</title>
    <link href="https://dariusf.github.io/blog/stack-heap/" />
    <updated>2021-02-07T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/stack-heap/</id>
    <content type="html">&lt;p&gt;I&#39;m teaching an introductory programming class this semester, which introduced students to the runtime stack and the heap in one of the early tutorials.&lt;/p&gt;
&lt;p&gt;For consistency across face-to-face and online classes, I decided to have the diagrams in my slides instead of drawing them terribly over and over.&lt;/p&gt;
&lt;p&gt;While there were lots of references for drawing such diagrams by hand, there didn&#39;t seem to be any small and simple tools for &lt;em&gt;generating&lt;/em&gt; them.
I only found &lt;a href=&quot;http://tug.ctan.org/tex-archive/macros/latex/contrib/drawstack/&quot;&gt;drawstack.sty&lt;/a&gt; (which does what it says on the box and only handles the stack), and everyone else seemed to use TikZ directly, which felt a little too low-level for this.&lt;/p&gt;
&lt;p&gt;So here&#39;s a tiny Python DSL for drawing a bunch of heap objects.
It uses the OG constraint-based graphic design tool, GraphViz.&lt;/p&gt;
&lt;p&gt;First, a cons list.&lt;/p&gt;
&lt;p&gt;&lt;img width=&quot;407&quot; height=&quot;191&quot; class=&quot;theme-affected&quot; alt=&quot;cons list&quot; src=&quot;https://dariusf.github.io/blog/stack-heap/conslist.svg&quot;&gt;&lt;/p&gt;
&lt;p&gt;Heap objects are shown with classic box-and-pointer diagrams. This is for Java, so we may have null fields.&lt;/p&gt;
&lt;pre class=&quot;language-python&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;List&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;head&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;tail&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;c&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;List&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;head&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;tail&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;b&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;List&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;head&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;tail&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
generate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;heap&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next, the stack.&lt;/p&gt;
&lt;!--
don&#39;t process svgs. size specified manually to avoid layout shift.
the sizes are the defaults if none are specified (which are used in --serve mode).
eleventy img in the prod build is a bit too correct, in that it reads the sizes
from the svgs and the images end up too small.
--&gt;
&lt;p&gt;&lt;img width=&quot;439&quot; height=&quot;221&quot; class=&quot;theme-affected&quot; alt=&quot;stack which contains references to heap objects&quot; src=&quot;https://dariusf.github.io/blog/stack-heap/stackheap.svg&quot;&gt;&lt;/p&gt;
&lt;p&gt;It&#39;s divided into named &lt;em&gt;frames&lt;/em&gt;, each of which contains many local variables for a particular function call.
We can show arrays too, and have arbitrary object graphs.&lt;/p&gt;
&lt;pre class=&quot;language-python&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;v1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;Vector2D&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;x&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;y&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;v2&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;Transform&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;parent&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;_self&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;pos&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; v1&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;t1&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  Frame&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;g&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; slots&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    Slot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;w&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    Slot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;this&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;t1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  Frame&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;f&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; slots&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    Slot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;z&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    Slot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;a&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
generate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; heap&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;v1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can also unhygienically embed arbitrary GraphViz strings, to do things like draw boxes around stuff (using a GraphViz &lt;code&gt;subgraph&lt;/code&gt;, which has the side effect of also grouping everything inside).&lt;/p&gt;
&lt;p&gt;&lt;img width=&quot;299&quot; height=&quot;279&quot; class=&quot;theme-affected&quot; alt=&quot;metaspace with a box around it&quot; src=&quot;https://dariusf.github.io/blog/stack-heap/metaspace.svg&quot;&gt;&lt;/p&gt;
&lt;pre class=&quot;language-python&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;bc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;Class&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;x&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;bc&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
ac &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;Class&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;ac&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
metaspace &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;Metaspace&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;B&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;B.A&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ac&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;meta&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Obj&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;typ&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;B&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; values&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ident&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;b&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
stack &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Frame&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;f&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; slots&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  Slot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;this&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
generate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stack&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; heap&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; bc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ac&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; metaspace&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; extra&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&#39;&#39;&#39;
  subgraph cluster_0 { ac; bc; meta; }
&#39;&#39;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Code available &lt;a href=&quot;https://gist.github.com/dariusf/e9b1515f59e6011d566cb6acf13f45a8&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Mouseover Minesweeper</title>
    <link href="https://dariusf.github.io/blog/minesweeper/" />
    <updated>2020-09-29T00:00:00Z</updated>
    <id>https://dariusf.github.io/blog/minesweeper/</id>
    <content type="html">&lt;p&gt;Automation in puzzle games is tricky to balance.
The issue is that puzzle games can involve some busywork, e.g. keeping track of the possibilities for each cell in Sudoku, and that removing the tedious parts allows the player to &lt;a href=&quot;https://www.playgoodsudoku.com/&quot;&gt;focus on the &amp;quot;interesting&amp;quot; parts&lt;/a&gt; of the puzzle.&lt;/p&gt;
&lt;p&gt;Unfortunately, the parts of the game that are core to its experience can be quite subjective.
Automation can also quickly spiral out of control, where adding a single rule (e.g. transitivity) to a solver that barely helps makes it &lt;a href=&quot;https://magnushoff.com/articles/minesweeper/&quot;&gt;practically solve the game completely&lt;/a&gt;, making you wonder what is left to &amp;quot;play&amp;quot;.&lt;/p&gt;
&lt;h1 id=&quot;chording&quot;&gt;Chording&lt;/h1&gt;
&lt;p&gt;Something distinctive about Minesweeper is the use of a mouse chord: pressing both mouse buttons reveals the tiles around if it is safe to do so, given the number under the cursor.
If it is not safe, nothing is revealed; the player almost always then flags the tiles they think contain mines, then repeats the chord.&lt;/p&gt;
&lt;p&gt;It&#39;s fun to chord away and perform small deductions, but on large boards, there is &lt;em&gt;a lot&lt;/em&gt; of chording and clicking, causing my hand to ache. Perhaps a justifiable example of tedium that could be removed?&lt;/p&gt;
&lt;p&gt;To test that, I found a &lt;a href=&quot;https://github.com/amyngyn/minesweeper&quot;&gt;nice open source version&lt;/a&gt; and made a few small tweaks. Moving the mouse over a number either reveals or flags surrounding tiles automatically, whenever it is unambiguous what should be done. Try it out &lt;a href=&quot;https://dariusf.github.io/mouseover-minesweeper/&quot;&gt;here&lt;/a&gt;!&lt;/p&gt;
&lt;h1 id=&quot;takeaways&quot;&gt;Takeaways&lt;/h1&gt;
&lt;p&gt;Moving the mouse intentionally, the speed at which you can mow through the board is really quite thrilling.
The busywork that is automated is the repeated clicking; &lt;em&gt;where&lt;/em&gt; to click, arguably the intentional part of the action, is still left to the player.&lt;/p&gt;
&lt;p&gt;The downside is that it&#39;s now possible to rely too much on automation, revealing most of the board by waving the mouse mindlessly, which is not really in the spirit of this change.
Accidental &amp;quot;spoilers&amp;quot; are also possible, if the mouse moves faster than you&#39;re thinking.
However, it&#39;s no worse than a solver which applies transitivity; at least you have to point at the tiles.
Also, how different is it really from clicking reflexively and drifting into pattern-matching mode?&lt;/p&gt;
&lt;p&gt;While we&#39;re comparing, this does nothing about randomness (what &lt;a href=&quot;https://magnushoff.com/articles/minesweeper/&quot;&gt;Magnus&lt;/a&gt; mainly addresses), so it&#39;s still possible to lose from bad luck, e.g. in the first tile, or at the end of the game. My win rate did not improve, only my timing.&lt;/p&gt;
&lt;p&gt;After trying it for a while, I found it difficult to play Minesweeper with the original controls and at the original speed, suggesting that this is an improvement.
At the same time, the ease with which boards can be mostly solved now makes me wonder if something was lost.&lt;/p&gt;
</content>
  </entry>
</feed>