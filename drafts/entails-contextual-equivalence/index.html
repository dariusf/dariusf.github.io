<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">

		<meta property="og:title" content="Darius Foo">
		<meta property="og:type" content="article">
		<meta property="og:url" content="https://dariusf.github.io">
		<meta property="og:image" content="https://dariusf.github.io/avatar.png">

		<title>From entailment to contextual refinement</title>
		<meta name="description" content="PhD student, programming languages and formal verification">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Darius Foo">


		

		

		

		

		
		
		<style>@media (prefers-color-scheme: light) { /**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #9a6e3a;
	/* This background color was intended by the author of this theme. */
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function,
.token.class-name {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
 }
@media (prefers-color-scheme: dark) { /**
 * prism.js tomorrow night eighties for JavaScript, CoffeeScript, CSS and HTML
 * Based on https://github.com/chriskempson/tomorrow-theme
 * @author Rose Pritchard
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #ccc;
	background: none;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;

}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #2d2d2d;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.block-comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #999;
}

.token.punctuation {
	color: #ccc;
}

.token.tag,
.token.attr-name,
.token.namespace,
.token.deleted {
	color: #e2777a;
}

.token.function-name {
	color: #6196cc;
}

.token.boolean,
.token.number,
.token.function {
	color: #f08d49;
}

.token.property,
.token.class-name,
.token.constant,
.token.symbol {
	color: #f8c555;
}

.token.selector,
.token.important,
.token.atrule,
.token.keyword,
.token.builtin {
	color: #cc99cd;
}

.token.string,
.token.char,
.token.attr-value,
.token.regex,
.token.variable {
	color: #7ec699;
}

.token.operator,
.token.entity,
.token.url {
	color: #67cdcc;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

.token.inserted {
	color: green;
}
 }
/* This is an arbitrary CSS string added to the bundle */
:root {
	/* --font-family: -apple-system, system-ui, sans-serif; */
	/* --font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
	*/

    --font-family-monospace: Fira Code, Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace;


  /*    --text-font: Crimson Text, serif;*/
  /*    --text-font: Poppins, Verdana, sans-serif;*/
  /*    --heading-font: Quicksand, sans-serif;*/
  /*    --text-font: Open Sans, sans-serif;*/
  /*    --text-font-size: 16px;*/
  /*    --heading-font: Open Sans, sans-serif;*/
  /*    --text-font: Cabin, sans-serif;*/
  /*    --text-font-size: 16px;*/
  /*    --text-font: Roboto, sans-serif;*/

  /*    --heading-font: Roboto, sans-serif;*/
  /*    --heading-font: Cabin, sans-serif;*/
  /*    --heading-font: Dosis, sans-serif;*/

  /*    --heading-font: Work Sans, sans-serif;*/
  /*    --text-font: Open Sans, sans-serif;*/

      /* --heading-font: Nunito, sans-serif; */
      --heading-font: ui-rounded, 'Hiragino Maru Gothic ProN', Quicksand, Comfortaa, Manjari, 'Arial Rounded MT', 'Arial Rounded MT Bold', Calibri, source-sans-pro, sans-serif;
  /*    --text-font: PT Sans, sans-serif;*/

  /*    --heading-font: Varela Round, sans-serif;*/
  /*    --text-font: Noto Serif, serif;*/

  /*    --text-font: Lato, sans-serif;*/
      --text-font-size: 17px;

  /*    --text-font: Merriweather, sans-serif;*/
  /*    --text-font-size: 16px;*/

  /* https://css-tricks.com/snippets/css/system-font-stack/ */
  /* https://systemfontstack.com/ */

    /* system font on all platforms */
  /*    --heading-font: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu;*/
      /* --text-font: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu; */
      --text-font: -apple-system, system-ui, sans-serif;
			/* system-ui, sans-serif; */


/* Theme colors */

	/* --color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333; */

	--background-color: #fff;

	/* --text-color: var(--color-gray-90); */
	/* --text-color-link: #082840; */

	/* --text-color-link: #ff0000; */
	/* --text-color-link-active: #5f2b48; */
	/* --text-color-link-visited: #17050F; */


	/* --syntax-tab-size: 2; */

	--bright-text-color: #222;
	--link-color: #3273dc;
	/* --link-color: #ff5e6c; */
	--link-visited-color: #6e4bbe;
	--background-color: #fff;
	--text-color: #444;
	--faded-text-color: #777;
	--blockquote-text-color: var(--bright-text-color);
	--faint-color: #ccc;
}

@media (prefers-color-scheme: dark) {
	:root {
		/* --color-gray-20: #e0e0e0; */
		/* --color-gray-50: #C0C0C0; */
		/* --color-gray-90: #dad8d8; */

		/* --text-color is assigned to --color-gray-_ above */
		/* --text-color-link: #1493fb; */
		/* --text-color-link-active: #6969f7; */
		/* --text-color-link-visited: #a6a6f8; */

		--background-color: #15202b;

		--bright-text-color: #eee;
		--link-color: #8cc2dd;
		--link-visited-color: #b9a9e0;
		--background-color: #333;
		--text-color: #ddd;
		--faded-text-color: #aaa;
		--slightly-dimmer-text-color: #ccc;
		--blockquote-text-color: var(--slightly-dimmer-text-color);
		--faint-color: #666;

		color-scheme: dark; /* sets scrollbar colour */
	}

	.theme-affected {
		filter: invert(.8);
	}
}

body {
	box-sizing: border-box;

	/* https://github.com/sindresorhus/github-markdown-css */
	min-width: 200px;
	/* max from old blog */
	/* max-width: 40em; */
	/* tiny bit wider because prism adds some padding */
	max-width: 726px;

	margin: 0 auto;
	padding: 0 20px;

	/* enable ligatures */
	text-rendering: optimizeLegibility;

	font-family: var(--text-font);
	font-size: var(--text-font-size);
	color: var(--text-color);
	background-color: var(--background-color);

	/*
	text-align: left;
	word-wrap: break-word;
	overflow-wrap: break-word;
	*/
	/* line-height: 1.5; */
}

@media (max-width: 767px) {
	body {
		padding: 0px 1em;
	}
}

@view-transition {
	navigation: auto;
}

html {
	overflow-y: scroll;
}

/* https://github.com/Kimeiga/bahunya/blob/master/src/parts/_typography.css */
ul, ol {
  padding-left: 2em;
}

li {
	line-height: 1.5;
}

h1, h2, h3, h4, h5, h6 {
	font-family: var(--heading-font);
	color: var(--bright-text-color);
	font-weight: normal;
	line-height: 1.25;
}

footer {
	padding: 35px;
}

/* header {
	border-bottom: 1px dashed var(--color-gray-20);
} */


/* misc changes from here on */

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:has(img) {
	text-align: center;
}
/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img{
  max-width: 100%;
}
img[width][height] {
  height: auto;
}
/* img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
} */
video,
iframe {
	width: 100%;
	height: auto;
}
iframe {
	aspect-ratio: 16/9;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

a[href] {
	color: var(--link-color);
	text-decoration: none;
}

/* a[href]:visited {
	color: var(--link-visited-color);
} */

/* a[href]:hover,
a[href]:active { */
	/* color: var(--text-color-link-active); */
	/* text-decoration: underline; */
	/* text-decoration-thickness: 2px; */
/* } */

/* main :first-child {
	margin-top: 0;
} */

/* .links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
} */

table {
	margin: 1em 0;
	border-collapse: collapse;
}
table td,
table th {
	padding-right: 1em;
}
/* table thead tr th {
  border-bottom: solid var(--text-color) 2px;
  border-top: solid var(--text-color) 2px;
} */

.table-lines td {
  border-bottom: solid var(--text-color) 1px;
  border-top: solid var(--text-color) 1px;
}

/* pre,
code {
	font-family: var(--font-family-monospace) !important;
	font-size: 14px !important;
} */

/* override prism */
/* https://github.com/orgs/PrismJS/discussions/2859 */
code[class*="language-"],
pre[class*="language-"] {
	font-family: var(--font-family-monospace);
	font-size: 14px;
}

pre[class*="language-"] {
	margin-top: 0;
	margin-bottom: 1em;
}

pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	/* -moz-tab-size: var(--syntax-tab-size); */
	/* -o-tab-size: var(--syntax-tab-size); */
	/* tab-size: var(--syntax-tab-size); */
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}

.scroll-when-overflowing, pre {
	overflow-x: scroll;
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}

.scroll-when-overflowing::-webkit-scrollbar, pre::-webkit-scrollbar {
  display: none;
}

/* mathjax v4, where display math is not centered */
mjx-container {
	margin: auto;
}
header {
			/* display: flex; */
			/* gap: 2em; */
			border-right: 10px;
			/* flex-wrap: wrap; */
			/* justify-content: space-between; */
			/* align-items: center; */
			align-items: end;
			padding-top: 1em;
			/* padding: 1em; */
		}
.nav-item {
				font-family: var(--heading-font);
				padding-right: 5px;
				display: inline-block;
			}
			
			.nav-item a[href][aria-current="page"] {
				text-decoration: underline;
				text-decoration-thickness: 2px;
			}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		

		<header>

			
			
			
			<a href="/" style="padding-right: 10px; color: var(--text-color); font-family: var(--heading-font); font-size: 1.5em;">Darius Foo</a>
			
				
				
				
				
				
				
			
			
			<nav style="display: inline-block">
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul style="list-style: none; padding: 0; margin: 0;">
					<li class="nav-item"><a href="/blog/">Blog</a></li>
					<li class="nav-item"><a href="/research/">Research</a></li>
					<li class="nav-item"><a href="/work/">Work</a></li>
					<li class="nav-item"><a href="/games/">Games</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			

<h1 style="margin-top: 1rem; margin-bottom: 0.2em" id="from-entailment-to-contextual-refinement">From entailment to contextual refinement</h1>



<div class="post-metadata">
	
	<time style="font-size: 0.9em;" datetime="2025-10-29">29 Oct 2025</time>
	
	
</div>

<div class="blog-content">
<div style="display:none">
<p>[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]
[object Promise]</p>
</div>
<p>This post is about one particularly thorny obstacle on the journey to developing a mechanisation of staged logic for my PhD thesis.</p>
<p>First, some background on staged logic.
It is a specification logic for higher-order programs with effects.</p>
<p>Here is the syntax of its formulae. It is an untyped lambda calculus with specifications and logical connectives. [object Promise] is some formula for describing program states, like a heap formula from separation logic.</p>
[object Promise]<p>Like other logics, it comes with an entailment relation, initially defined as follows, where [object Promise] is a model of the logic.
The symmetric version, <em>equivalence</em>, is typically defined in terms of entailment.</p>
[object Promise]<p>This definition is known under many names in different communities.</p>
<ul>
<li>In other logics, such as <a href="https://softwarefoundations.cis.upenn.edu/slf-current/Himpl.html">separation logic</a>, it is written [object Promise] and called <em>entailment</em>, as a lifting of metalogic implication</li>
<li>In TLA[object Promise], where the two objects are temporal formulae representing state machines, it is written [object Promise] and called <a href="https://www.hillelwayne.com/post/refinement/">refinement</a></li>
<li>When the two objects are programs, it is called <a href="https://softwarefoundations.cis.upenn.edu/plf-current/Equiv.html">program approximation</a>, with the symmetric version called <em>behavioural equivalence</em>. In the context of compiler correctness, it is also a simple form of forward (or backward, <a href="https://sel4.discourse.group/t/forward-vs-backward-simulation-in-the-refinement-proof/490">depending on who you ask</a>) simulation</li>
<li>When the two objects are <a href="https://songyahui.github.io/ICFEM20.pdf">languages</a>, typically representing sets of strings, it is called <em>inclusion</em> and written [object Promise]</li>
<li>When the two objects are <a href="https://www.cs.princeton.edu/~appel/papers/funspec_sub.pdf">specifications</a>, the relation is written [object Promise] and called <em>subsumption</em></li>
<li>When the two objects are <a href="https://www.irif.fr/~gc/papers/icalp-ppdp05.pdf">types</a>, [object Promise] is instead called <em>subtyping</em></li>
</ul>
<p>Entailment intuitively means that the models or behaviours of [object Promise] are somehow &quot;contained in&quot; those of [object Promise].
When the operands are some kind of program, [object Promise] can be seen as a <em>specification</em> of [object Promise], as it &quot;bounds&quot; the behaviours the latter can have.
When the operands are logical formulae, [object Promise] is called <em>stronger</em> or <em>more precise</em>, in that it describes fewer models, since every model satisfying it will satisfy [object Promise].</p>
<p>We started with this and it <a href="/MechanizingStagedLogic.pdf">worked great</a> for interactive proofs in Rocq for a while.</p>
<h2 id="delimited-continuations-and-the-bubble-up-semantics">Delimited continuations and the bubble-up semantics</h2>
<p><a href="/drafts/delimited-control">other blog post</a>.</p>
<p>However, there were problems with shift and the bubble-up semantics.
We had shift results and no way to relate them.</p>
[object Promise]<p>where sequencing is defined as [object Promise].</p>
<p>Associativity broke.
Rewriting wouldn't work because proper instances</p>
<h2 id="many-indexed-non-solutions">Many indexed non-solutions</h2>
<p><em>gentails</em>, for &quot;generalised entails&quot;.
It also autocorrects poorly.</p>
<h2 id="a-similar-problem-in-the-lambda-calculus">A similar problem in the lambda calculus</h2>
<p>It turns out that this issue shows up in the lambda calculus.</p>
[object Promise]<p>Consider how to prove that these two expressions are equivalent.</p>
[object Promise]<p>According to the definition above, given that we know how [object Promise] evaluates, we have to show that [object Promise] evaluates to the same value.</p>
<p>Suppose we have a big-step semantics [object Promise].
A lambda expression is a value, and the rule for values just says:</p>
[object Promise]<p>In other words, no more evaluation takes place.</p>
<p>If we try this for the two programs above, we end up with distinct syntactic objects that are not equal, though we can so clearly see that they behave the same.</p>
<p>The way I originally described it to people (with the view that staged logic was a logic) was that we had &quot;syntax in the model&quot;. Which led to a rabbit hole of looking into denotational approaches to interpret that syntax with.</p>
<p>However, staged logic is equally viewed as an abstract programming language, and though it seems obvious in hindsight, the problem we had with bubbles is exactly the one described here with the lambda calculus.</p>
<h2 id="contextual-equivalence">Contextual equivalence</h2>
<p>The solution is a stronger notion of equivalence: <em>contextual equivalence</em> (with the asymmetric version being called <em>contextual refinement</em>).</p>
[object Promise]<p>It seems <a href="https://www.google.com/search?q=%22contextual+equivalence%22+%22gold+standard%22">customary</a> to call it the &quot;gold standard&quot; for a notion of equivalence, so I will repeat that here.</p>
<p>Why does it solve the problem? Consider the statement again.</p>
[object Promise]<p>We know that these expressions are equivalent informally because <em>no matter the argument we supply to each</em>, we'll get the same result. We might even have justified this to ourselves by mentally evaluating both sides with some symbolic value [object Promise] and seeing that we get exactly [object Promise] at the end.</p>
<p>In other words, if we only had some way to continue evaluating these expressions, we could easily tell that they were equivalent. The problem is that we can't do this, because they are already values - the big-step semantics has nothing more to say about them.</p>
<p>If only we had a way to describe hypothetical, future inputs to those programs...</p>
<p>Well, that's what contextual refinement offers. It quantifies over all contexts, so for all that don't get stuck and produce derivations, we are able to continue running these programs.
In other words, the context gives us a way to talk about how each lambda will eventually be used.</p>
<p>How would we actually prove this particular equivalence?
Direct induction over contexts is known to be <a href="https://dl.acm.org/doi/pdf/10.1145/3759427.3760374">&quot;notoriously difficult&quot;</a>.
The two tenable proof methods are
<a href="https://dl.acm.org/doi/pdf/10.1145/1889997.1890002">bisimulations</a> and <a href="https://cs.au.dk/~birke/papers/AnIntroductionToLogicalRelations.pdf">logical relations</a>.
I am more familiar with the latter, as it is much more commonly used in mechanised settings.</p>
<p>The idea there is to strengthen the definition of equivalence, so it more precisely says when two expressions are equivalent.
To cope with advanced language features, the definition will have to be inductive over the structure of types and/or the number of evaluation steps the program takes.</p>
<!-- A succinct set of slides describing the idea is [here](https://xavierleroy.org/CdF/2018-2019/8.pdf).
Amal Ahmed's [2015 OPLSS lectures](https://www.youtube.com/playlist?list=PLiHLLF-foEex7BOvMbrbUFC9XgU7fZW66) provide a great and more thorough introduction. -->
<p>It should also come as no surprise that the Proper instances we agonised over for so long are just simple corollaries of contextual equivalence.
Hence this relation can be used for rewriting.</p>
<!-- With that, we were finally able to formalise staged logic. -->
<p>With that, we seem to be finally able to formalise staged logic.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Discovering all this was a long and agonising journey, as the connections between these topics are typically discussed in very disparate settings.
I still don't know of any source which connects them like this, so I just wanted to put all this in words, so the next person who needs this connection not suffer a similar fate.</p>
<p>I'm grateful to the authors of a paper which pointed this out particularly clearly:
<a href="https://www.sciencedirect.com/science/article/pii/S2352220823000111">Program equivalence in an untyped, call-by-value functional language with uncurried functions</a>.
Moreover, it is for an untyped setting, which is a relatively interesting and unexplored one to apply logical relations in.</p>

</div>

		</main>

		<footer>
			
		</footer>

		<!-- This page `/drafts/entails-contextual-equivalence/` was built on 2025-12-06T06:57:03.497Z -->
		
	</body>
</html>
