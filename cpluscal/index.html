<!doctype html><html lang=en-US><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://dariusf.github.io/images/favicon.png><title>Choreographic PlusCal | Darius Foo</title>
<meta name=title content="Choreographic PlusCal"><meta name=description content='Choreographic PlusCal is a refinement of PlusCal with features for specifying distributed protocols.
choreography
  (C \in coordinators);
  (P \in participants);
{
  all (c \in coordinators) {
    task C, "phase1" {
      all (p \in participants) {
        Transmit(c, p, "prepare");
        either {
          Transmit(p, c, "prepared");
        } or {
          Transmit(p, c, "aborted");
          cancel "phase1";
        }
      }
    };
    if (aborted) {
      all (p \in participants) {
        Transmit(c, p, "abort");
        Transmit(p, c, "aborted");
      }
    } else {
      all (p \in participants) {
        Transmit(c, p, "commit");
        Transmit(p, c, "committed");
      }
    }
  }
}
Roles and parties
Protocol models in Choreographic PlusCal begin with definitions of roles, parties, and their local variables.
choreography
  (F \in failure_detectors),
  (P \in participants)
  variables
    voted_yes = {},
    voted_no = FALSE,
    outcome = "none";
{
  ...
}
A party is an identifier for a protocol participant, and is typically a model value.
Protocol participants have local state and communicate via messages.
A role is a set of parties.'><meta name=keywords content><meta property="og:url" content="https://dariusf.github.io/cpluscal/"><meta property="og:site_name" content="Darius Foo"><meta property="og:title" content="Choreographic PlusCal"><meta property="og:description" content='Choreographic PlusCal is a refinement of PlusCal with features for specifying distributed protocols.
choreography (C \in coordinators); (P \in participants); { all (c \in coordinators) { task C, "phase1" { all (p \in participants) { Transmit(c, p, "prepare"); either { Transmit(p, c, "prepared"); } or { Transmit(p, c, "aborted"); cancel "phase1"; } } }; if (aborted) { all (p \in participants) { Transmit(c, p, "abort"); Transmit(p, c, "aborted"); } } else { all (p \in participants) { Transmit(c, p, "commit"); Transmit(p, c, "committed"); } } } } Roles and parties Protocol models in Choreographic PlusCal begin with definitions of roles, parties, and their local variables.
choreography (F \in failure_detectors), (P \in participants) variables voted_yes = {}, voted_no = FALSE, outcome = "none"; { ... } A party is an identifier for a protocol participant, and is typically a model value. Protocol participants have local state and communicate via messages. A role is a set of parties.'><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-12-31T11:15:45+08:00"><meta property="article:modified_time" content="2023-12-31T11:15:45+08:00"><meta property="og:image" content="https://dariusf.github.io/images/favicon.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dariusf.github.io/images/favicon.png"><meta name=twitter:title content="Choreographic PlusCal"><meta name=twitter:description content='Choreographic PlusCal is a refinement of PlusCal with features for specifying distributed protocols.
choreography (C \in coordinators); (P \in participants); { all (c \in coordinators) { task C, "phase1" { all (p \in participants) { Transmit(c, p, "prepare"); either { Transmit(p, c, "prepared"); } or { Transmit(p, c, "aborted"); cancel "phase1"; } } }; if (aborted) { all (p \in participants) { Transmit(c, p, "abort"); Transmit(p, c, "aborted"); } } else { all (p \in participants) { Transmit(c, p, "commit"); Transmit(p, c, "committed"); } } } } Roles and parties Protocol models in Choreographic PlusCal begin with definitions of roles, parties, and their local variables.
choreography (F \in failure_detectors), (P \in participants) variables voted_yes = {}, voted_no = FALSE, outcome = "none"; { ... } A party is an identifier for a protocol participant, and is typically a model value. Protocol participants have local state and communicate via messages. A role is a set of parties.'><meta itemprop=name content="Choreographic PlusCal"><meta itemprop=description content='Choreographic PlusCal is a refinement of PlusCal with features for specifying distributed protocols.
choreography (C \in coordinators); (P \in participants); { all (c \in coordinators) { task C, "phase1" { all (p \in participants) { Transmit(c, p, "prepare"); either { Transmit(p, c, "prepared"); } or { Transmit(p, c, "aborted"); cancel "phase1"; } } }; if (aborted) { all (p \in participants) { Transmit(c, p, "abort"); Transmit(p, c, "aborted"); } } else { all (p \in participants) { Transmit(c, p, "commit"); Transmit(p, c, "committed"); } } } } Roles and parties Protocol models in Choreographic PlusCal begin with definitions of roles, parties, and their local variables.
choreography (F \in failure_detectors), (P \in participants) variables voted_yes = {}, voted_no = FALSE, outcome = "none"; { ... } A party is an identifier for a protocol participant, and is typically a model value. Protocol participants have local state and communicate via messages. A role is a set of parties.'><meta itemprop=datePublished content="2023-12-31T11:15:45+08:00"><meta itemprop=dateModified content="2023-12-31T11:15:45+08:00"><meta itemprop=wordCount content="813"><meta itemprop=image content="https://dariusf.github.io/images/favicon.png"><meta name=referrer content="no-referrer-when-downgrade"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Code"><style>@media(prefers-color-scheme:light){:root{--bright-text-color:#222;--link-color:#3273dc;--link-visited-color:#6e4bbe;--background-color:#fff;--text-color:#444;--faded-text-color:#777;--blockquote-text-color:var(--bright-text-color);--faint-color:#ccc}.chroma{background-color:#fff}.chroma .x{}.chroma .err{color:#000}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#a90d91}.chroma .kc{color:#a90d91}.chroma .kd{color:#a90d91}.chroma .kn{color:#a90d91}.chroma .kp{color:#a90d91}.chroma .kr{color:#a90d91}.chroma .kt{color:#a90d91}.chroma .n{color:#000}.chroma .na{color:#836c28}.chroma .nb{color:#a90d91}.chroma .bp{color:#5b269a}.chroma .nc{color:#3f6e75}.chroma .no{color:#000}.chroma .nd{color:#000}.chroma .ni{color:#000}.chroma .ne{color:#000}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#000}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#000}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#1c01ce}.chroma .ld{color:#1c01ce}.chroma .s{color:#c41a16}.chroma .sa{color:#c41a16}.chroma .sb{color:#c41a16}.chroma .sc{color:#2300ce}.chroma .dl{color:#c41a16}.chroma .sd{color:#c41a16}.chroma .s2{color:#c41a16}.chroma .se{color:#c41a16}.chroma .sh{color:#c41a16}.chroma .si{color:#c41a16}.chroma .sx{color:#c41a16}.chroma .sr{color:#c41a16}.chroma .s1{color:#c41a16}.chroma .ss{color:#c41a16}.chroma .m{color:#1c01ce}.chroma .mb{color:#1c01ce}.chroma .mf{color:#1c01ce}.chroma .mh{color:#1c01ce}.chroma .mi{color:#1c01ce}.chroma .il{color:#1c01ce}.chroma .mo{color:#1c01ce}.chroma .o{color:#000}.chroma .ow{color:#000}.chroma .p{}.chroma .c{color:#177500}.chroma .ch{color:#177500}.chroma .cm{color:#177500}.chroma .c1{color:#177500}.chroma .cs{color:#177500}.chroma .cp{color:#633820}.chroma .cpf{color:#633820}.chroma .g{}.chroma .gd{}.chroma .ge{}.chroma .gr{}.chroma .gh{}.chroma .gi{}.chroma .go{}.chroma .gp{}.chroma .gs{}.chroma .gu{}.chroma .gt{}.chroma .gl{}.chroma .w{}}@media(prefers-color-scheme:dark){:root{--bright-text-color:#eee;--link-color:#8cc2dd;--link-visited-color:#b9a9e0;--background-color:#333;--text-color:#ddd;--faded-text-color:#aaa;--slightly-dimmer-text-color:#ccc;--blockquote-text-color:var(--slightly-dimmer-text-color);--faint-color:#666;color-scheme:dark}img.theme-affected{filter:invert(.8)}.chroma{color:#e2e4e5;background-color:#282a36}.chroma .x{}.chroma .err{color:#ff5c57}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#ff6ac1}.chroma .kc{color:#ff6ac1}.chroma .kd{color:#ff5c57}.chroma .kn{color:#ff6ac1}.chroma .kp{color:#ff6ac1}.chroma .kr{color:#ff6ac1}.chroma .kt{color:#9aedfe}.chroma .n{}.chroma .na{color:#57c7ff}.chroma .nb{color:#ff5c57}.chroma .bp{}.chroma .nc{color:#f3f99d}.chroma .no{color:#ff9f43}.chroma .nd{color:#ff9f43}.chroma .ni{}.chroma .ne{}.chroma .nf{color:#57c7ff}.chroma .fm{}.chroma .nl{color:#ff5c57}.chroma .nn{}.chroma .nx{}.chroma .py{}.chroma .nt{color:#ff6ac1}.chroma .nv{color:#ff5c57}.chroma .vc{color:#ff5c57}.chroma .vg{color:#ff5c57}.chroma .vi{color:#ff5c57}.chroma .vm{}.chroma .l{}.chroma .ld{}.chroma .s{color:#5af78e}.chroma .sa{color:#5af78e}.chroma .sb{color:#5af78e}.chroma .sc{color:#5af78e}.chroma .dl{color:#5af78e}.chroma .sd{color:#5af78e}.chroma .s2{color:#5af78e}.chroma .se{color:#5af78e}.chroma .sh{color:#5af78e}.chroma .si{color:#5af78e}.chroma .sx{color:#5af78e}.chroma .sr{color:#5af78e}.chroma .s1{color:#5af78e}.chroma .ss{color:#5af78e}.chroma .m{color:#ff9f43}.chroma .mb{color:#ff9f43}.chroma .mf{color:#ff9f43}.chroma .mh{color:#ff9f43}.chroma .mi{color:#ff9f43}.chroma .il{color:#ff9f43}.chroma .mo{color:#ff9f43}.chroma .o{color:#ff6ac1}.chroma .ow{color:#ff6ac1}.chroma .p{}.chroma .c{color:#78787e}.chroma .ch{color:#78787e}.chroma .cm{color:#78787e}.chroma .c1{color:#78787e}.chroma .cs{color:#78787e}.chroma .cp{color:#78787e}.chroma .cpf{color:#78787e}.chroma .g{}.chroma .gd{color:#ff5c57}.chroma .ge{text-decoration:underline}.chroma .gr{color:#ff5c57}.chroma .gh{font-weight:700}.chroma .gi{font-weight:700}.chroma .go{color:#43454f}.chroma .gp{}.chroma .gs{font-style:italic}.chroma .gu{font-weight:700}.chroma .gt{}.chroma .gl{text-decoration:underline}.chroma .w{}}:root{--heading-font:ui-rounded, 'Hiragino Maru Gothic ProN', Quicksand, Comfortaa, Manjari, 'Arial Rounded MT', 'Arial Rounded MT Bold', Calibri, source-sans-pro, sans-serif;--text-font-size:17px;--text-font:system-ui, sans-serif}*{margin:0}body{}main{margin-top:.75em}sup{vertical-align:top;font-size:.7em}p{margin-bottom:1em}html{overflow-x:hidden;margin-right:calc(-1 * (100vw - 100%))}body{font-family:var(--text-font);font-size:var(--text-font-size);margin:auto;padding:20px;max-width:720px;text-align:left;background-color:var(--background-color);color:var(--text-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5}h1,h2,h3,h4,h5,h6{font-family:var(--heading-font);color:var(--bright-text-color);font-weight:400}.blog-content h1,.blog-content h2,.blog-content h3,.blog-content h4,.blog-content h5,.blog-content h6{margin-top:.5em}hr,ul,ol{margin-bottom:.5em}div>iframe{margin-bottom:.5em}.blog-timestamp{font-size:.9em}.blog-content{margin-top:1.5em}a{color:var(--link-color);text-decoration:none}.title{color:var(--text-color);font-size:1.5em;font-family:var(--heading-font);margin-right:10px}nav a{margin-right:8px;font-family:var(--heading-font)}.paper-item svg{width:16px;vertical-align:text-bottom}.menuactive{text-decoration:underline;text-decoration-thickness:2px}table{width:100%}img{max-width:100%;margin:auto;margin-bottom:.5em;display:block}code{padding:2px 5px;margin-bottom:1em;font-family:Fira Code,monospace;font-size:14px;line-height:1.4}pre code{display:block;padding:20px;white-space:pre-wrap;overflow-x:auto}pre{border-radius:10px}p code,ol code,ul code,summary code{border-radius:4px;border:solid var(--faint-color)1px;margin:0 2px;padding:1px 2px}blockquote{border-left:1px solid #999;color:var(--blockquote-text-color);padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.deemphasize{color:var(--faded-text-color)}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px;text-align:right;margin-right:20px}ul.blog-posts li a:visited{color:var(--link-visited-color)}</style></head><body><header><a href=/><span class=title>Darius Foo</span></a><nav style=display:inline-block><a href=/blog/>Blog</a>
<a href=/research/>Research</a>
<a href=/work/>Work</a>
<a href=/other/>Other</a></nav></header><main><h1>Choreographic PlusCal</h1><div><time class=blog-timestamp datetime=2023-12-31 pubdate>31 Dec, 2023</time></div><div class=blog-content><p>Choreographic PlusCal is a refinement of PlusCal with features for specifying distributed protocols.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>choreography</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>C</span> <span class=err>\</span><span class=n>in</span> <span class=n>coordinators</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>P</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>all</span> <span class=p>(</span><span class=n>c</span> <span class=err>\</span><span class=n>in</span> <span class=n>coordinators</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>task</span> <span class=n>C</span><span class=p>,</span> <span class=s>&#34;phase1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>all</span> <span class=p>(</span><span class=n>p</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>Transmit</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=s>&#34;prepare&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>either</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>Transmit</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=s>&#34;prepared&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>or</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>Transmit</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=s>&#34;aborted&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>cancel</span> <span class=s>&#34;phase1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>aborted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>all</span> <span class=p>(</span><span class=n>p</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>Transmit</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=s>&#34;abort&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>Transmit</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=s>&#34;aborted&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>all</span> <span class=p>(</span><span class=n>p</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>Transmit</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=s>&#34;commit&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>Transmit</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=s>&#34;committed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=roles-and-parties>Roles and parties</h2><p>Protocol models in Choreographic PlusCal begin with definitions of <em>roles</em>, <em>parties</em>, and their local variables.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>choreography</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>F</span> <span class=err>\</span><span class=n>in</span> <span class=n>failure_detectors</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>P</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>variables</span>
</span></span><span class=line><span class=cl>    <span class=n>voted_yes</span> <span class=o>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=n>voted_no</span> <span class=o>=</span> <span class=n>FALSE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>outcome</span> <span class=o>=</span> <span class=s>&#34;none&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>A <em>party</em> is an identifier for a protocol participant, and is typically a model value.
Protocol participants have local state and communicate via messages.
A <em>role</em> is a set of parties.</p><h2 id=choreography-and-transmit>choreography and Transmit</h2><p>A <code>choreography</code> lives at the same level as a PlusCal <code>process</code>, and is special in that it describes the protocol <em>globally</em>, from the perspective of all parties simultaneously.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>choreography</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>C</span> <span class=err>\</span><span class=n>in</span> <span class=n>coordinators</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>P</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>all</span> <span class=p>(</span><span class=n>c</span> <span class=err>\</span><span class=n>in</span> <span class=n>coordinators</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>all</span> <span class=p>(</span><span class=n>p</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>Transmit</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=s>&#34;a&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>Transmit</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Within a <code>choreography</code>, new global constructs can be used.
The most important is <code>Transmit</code> for sending messages, which can be arbitrary data.
Any network semantics can be specified for it by implementing simple <code>Send</code> and <code>Receive</code> macros.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>macro</span> <span class=nf>Send</span><span class=p>(</span><span class=n>from</span><span class=p>,</span> <span class=n>to</span><span class=p>,</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nl>messages</span> <span class=p>:</span><span class=o>=</span> <span class=n>messages</span> <span class=err>\</span><span class=k>union</span> <span class=p>{[</span><span class=n>To</span> <span class=o>|-&gt;</span> <span class=n>to</span><span class=p>,</span> <span class=n>From</span> <span class=o>|-&gt;</span> <span class=n>from</span><span class=p>,</span> <span class=n>Type</span> <span class=o>|-&gt;</span> <span class=n>type</span><span class=p>]};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>macro</span> <span class=nf>Receive</span><span class=p>(</span><span class=n>from</span><span class=p>,</span> <span class=n>to</span><span class=p>,</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>await</span> <span class=p>[</span><span class=n>To</span> <span class=o>|-&gt;</span> <span class=n>to</span><span class=p>,</span> <span class=n>From</span> <span class=o>|-&gt;</span> <span class=n>from</span><span class=p>,</span> <span class=n>Type</span> <span class=o>|-&gt;</span> <span class=n>type</span><span class=p>]</span> <span class=err>\</span><span class=n>in</span> <span class=n>messages</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Choreographic PlusCal works by <em>projecting</em> choreographies into regular PlusCal processes, so it fits nicely into the PlusCal translator pipeline.</p><h2 id=all-and-par>all and par</h2><p>Multicasts are the workhorse of consensus and commit protocols, among other role-uniform operations.
These are expressible with <code>all</code>, which is dual to PlusCal's <a href=https://lamport.azurewebsites.net/pubs/pluscal.pdf><code>with</code></a>: instead of executing its body for an arbitrarily chosen element of a set, its body executes for <em>all</em> elements of the set, <em>concurrently</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>choreography</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>C</span> <span class=err>\</span><span class=n>in</span> <span class=n>coordinators</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>P</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>all</span> <span class=p>(</span><span class=n>c</span> <span class=err>\</span><span class=n>in</span> <span class=n>coordinators</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>all</span> <span class=p>(</span><span class=n>p</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>Transmit</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=s>&#34;prepare&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>par { ... } and { ... }</code>, which is dual to <code>either { ... } or { ... }</code>, is used for parallel composition of different blocks of statements, instead of the same block many times.</p><p>Unlike PlusCal process and Distributed PlusCal threads, <code>par</code> and <code>all</code> can be nested arbitrarily.
Both have a fork-join semantics when composed sequentially.</p><h2 id=tasks-and-cancellation>Tasks and cancellation</h2><p><code>task</code>s delimit a block of statements which will no longer take effect following a <code>cancel</code>lation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>all</span> <span class=p>(</span><span class=n>p</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>task</span> <span class=n>P</span><span class=p>,</span> <span class=s>&#34;a&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>par</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cancel</span> <span class=s>&#34;a&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nl>x</span> <span class=p>:</span><span class=o>=</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=err>\</span><span class=o>*</span> <span class=n>x</span> <span class=n>is</span> <span class=mi>0</span> <span class=n>or</span> <span class=mi>2</span> <span class=n>on</span> <span class=n>each</span> <span class=n>participant</span>
</span></span></code></pre></div><p>In the Two-phase Commit example above, the task delimits the first phase of the protocol, which ends <em>as soon as</em> the first <code>"aborted"</code> message is received.
Notably, the coordinator will no longer even <em>receive</em> messages following the cancellation, and does not have to wait for <code>all</code> subprocesses to be "joined".</p><p>This provides a principled and easy way to implement such optimizations, which would otherwise be tricky to express.</p><p>Cancellation is also an interesting control flow primitive.
For example, it can be <a href=https://github.com/dariusf/tlaplus/blob/mbtc/cpcal.t/RaftLE.tla>used with loops</a> to express infinite repetition of a task which completes to a different extent each time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=n>TRUE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>task</span> <span class=n>servers</span><span class=p>,</span> <span class=s>&#34;s&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>par</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=err>\</span><span class=o>*</span> <span class=n>A</span>
</span></span><span class=line><span class=cl>      <span class=err>\</span><span class=o>*</span> <span class=n>B</span>
</span></span><span class=line><span class=cl>      <span class=err>\</span><span class=o>*</span> <span class=n>C</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cancel</span> <span class=s>&#34;s&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=err>\</span><span class=o>*</span> <span class=n>produces</span> <span class=n>the</span> <span class=nf>behavior</span> <span class=p>(</span><span class=nf>A</span><span class=p>(</span><span class=nf>B</span><span class=p>(</span><span class=n>C</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=o>*</span>
</span></span></code></pre></div><h2 id=dynamic-multirole-protocols-and-self-sends>Dynamic multirole protocols and self-sends</h2><p>Protocols such as <a href=https://github.com/dariusf/tlaplus/blob/mbtc/cpcal.t/NBAC.tla>Nonblocking Atomic Commit</a> feature intra-role communication, or <em>self-sends</em>. Others such as <a href=https://github.com/dariusf/tlaplus/blob/mbtc/cpcal.t/RaftLE.tla>Raft</a> additionally have only a single static role, changing role dynamically based on node state.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>all</span> <span class=p>(</span><span class=n>s</span> <span class=err>\</span><span class=n>in</span> <span class=n>servers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Transmit</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=s>&#34;RequestVote&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Choreographic PlusCal handles both in a principled way with a <a href=/selfsends>projection function</a> based on the theory of dynamic multirole session types.</p><h2 id=multiparty-loops>Multiparty loops</h2><p><em>Multiparty loops</em> allow repetition across multiple roles, with a termination condition for each role to be projected with respect to.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>all</span> <span class=p>(</span><span class=n>c</span> <span class=err>\</span><span class=n>in</span> <span class=n>coordinators</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>all</span> <span class=p>(</span><span class=n>p</span> <span class=err>\</span><span class=n>in</span> <span class=n>participants</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>y</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>),</span> <span class=p>(</span><span class=n>x</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>Transmit</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nl>y</span> <span class=p>:</span><span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nl>x</span> <span class=p>:</span><span class=o>=</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=prototype>Prototype</h2><p>This project is a research prototype and its <a href=https://github.com/dariusf/tlaplus/tree/mbtc>implementation</a> is mostly a proof-of-concept.
However, it is built on top of the TLA+ tools, so with more work it could someday be used to specify (and verify) real protocols.
Please get in touch if you are interested!</p><h2 id=resources>Resources</h2><ul><li><a href=https://github.com/dariusf/tlaplus/tree/mbtc/cpcal.t>Gallery of example programs</a></li><li><a href=/selfsends>How projection works</a></li><li><a href=https://dariusf.github.io/cpluscal.pdf>The paper</a>, which contains an extensive tutorial-style introduction and lots of detail on how projection and translation to PlusCal work</li></ul></div><p></p></main><footer></footer></body></html>